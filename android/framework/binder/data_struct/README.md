# binder

## ç®€ä»‹

binder è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶æ˜¯åœ¨ Openbinder çš„åŸºç¡€ä¸Šå®ç°çš„ï¼Œå®ƒé‡‡ç”¨ CS é€šä¿¡æ–¹å¼ï¼Œå…¶ä¸­ï¼Œæä¾›æœåŠ¡çš„è¿›ç¨‹ç§°ä¸º Server è¿›ç¨‹ï¼Œè€Œè®¿é—®æœåŠ¡çš„è¿›ç¨‹ç§°ä¸ºClientè¿›ç¨‹ã€‚åŒä¸€ä¸ª Server è¿›ç¨‹å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªç»„ä»¶æ¥å‘ Client è¿›ç¨‹æä¾›æœåŠ¡ï¼Œè¿™äº›ç»„ä»¶ç§°ä¸º Service ç»„ä»¶ã€‚åŒæ—¶ï¼ŒåŒä¸€ä¸ª Client è¿›ç¨‹ä¹Ÿå¯ä»¥åŒæ—¶å‘å¤šä¸ªService ç»„ä»¶è¯·æ±‚æœåŠ¡ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚éƒ½å¯¹åº”æœ‰ä¸€ä¸ª Client ç»„ä»¶ï¼Œæˆ–è€…ç§°ä¸º Service ä»£ç†å¯¹è±¡ã€‚binder è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶çš„æ¯ä¸€ä¸ª Server è¿›ç¨‹å’Œ Client è¿›ç¨‹éƒ½ç»´æŠ¤ä¸€ä¸ª binder çº¿ç¨‹æ± æ¥å¤„ç†è¿›ç¨‹é—´çš„é€šä¿¡è¯·æ±‚ï¼Œå› æ­¤ï¼ŒServer è¿›ç¨‹å’Œ Client è¿›ç¨‹å¯ä»¥å¹¶å‘åœ°æä¾›å’Œè®¿é—®æœåŠ¡ã€‚

Server è¿›ç¨‹å’Œ Client è¿›ç¨‹çš„é€šä¿¡è¦ä¾é è¿è¡Œåœ¨å†…æ ¸ç©ºé—´çš„ binder é©±åŠ¨ç¨‹åºæ¥è¿›è¡Œã€‚binder é©±åŠ¨ç¨‹åºå‘ç”¨æˆ·ç©ºé—´æš´éœ²äº†ä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ /dev/binderï¼Œä½¿å¾—åº”ç”¨ç¨‹åºè¿›ç¨‹å¯ä»¥é—´æ¥åœ°é€šè¿‡å®ƒæ¥å»ºç«‹é€šä¿¡é€šé“ã€‚Service ç»„ä»¶åœ¨å¯åŠ¨æ—¶ï¼Œä¼šå°†è‡ªå·±æ³¨å†Œåˆ°ä¸€ä¸ª Service Manager ç»„ä»¶ä¸­ï¼Œä»¥ä¾¿ Client ç»„ä»¶å¯ä»¥é€šè¿‡ ServiceManager ç»„ä»¶æ‰¾åˆ°å®ƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°† Service Manager ç»„ä»¶ç§°ä¸º binder è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…ï¼ŒåŒæ—¶ç”±äºå®ƒä¹Ÿéœ€è¦ä¸æ™®é€šçš„ Server è¿›ç¨‹å’ŒClientè¿›ç¨‹é€šä¿¡ï¼Œæˆ‘ä»¬ä¹Ÿå°†å®ƒçœ‹ä½œæ˜¯ä¸€ä¸ª Service ç»„ä»¶ï¼Œåªä¸è¿‡å®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Service ç»„ä»¶ã€‚

<img src="android/framework/binder/data_struct/resources/1.png" style="width:80%">

ä»å›¾å¯ä»¥çœ‹å‡ºï¼ŒClientã€Service å’Œ Service Manager è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œè€Œ binder é©±åŠ¨ç¨‹åºè¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå…¶ä¸­ï¼ŒService Manager å’Œ binder é©±åŠ¨ç¨‹åºç”±ç³»ç»Ÿè´Ÿè´£æä¾›ï¼Œè€Œ Client å’Œ Service ç»„ä»¶ç”±åº”ç”¨ç¨‹åºæ¥å®ç°ã€‚Clientã€Service å’Œ Service Manager å‡æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ openã€mmap å’Œioctl æ¥è®¿é—®è®¾å¤‡æ–‡ä»¶ /dev/binderï¼Œä»è€Œå®ç°ä¸ binder é©±åŠ¨ç¨‹åºçš„äº¤äº’ï¼Œè€Œäº¤äº’çš„ç›®çš„å°±æ˜¯ä¸ºäº†èƒ½å¤Ÿé—´æ¥åœ°æ‰§è¡Œè¿›ç¨‹é—´é€šä¿¡ã€‚

## åŸºç¡€æ•°æ®ç»“æ„

### binder_work

æè¿°ä¸€ä¸ªå¾…å¤„ç†çš„å·¥ä½œé¡¹, å…¶ä¸­ entry æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„ç»“æ„ï¼Œç”¨æ¥å°† binder_work ç»„ç»‡èµ·æ¥æˆä¸€ä¸ªé“¾è¡¨ã€‚type è¡¨ç¤ºå·¥ä½œé¡¹çš„ç±»å‹ã€‚

```c

struct list_head {
    struct list_head *next, *prev;
};

struct binder_work {
    struct list_head entry;
    enum {
        BINDER_WORK_TRANSACTION = 1, // æœ‰æ–°çš„ binder äº‹åŠ¡ï¼ˆRPC è°ƒç”¨ï¼‰éœ€è¦å¤„ç†ã€‚
        BINDER_WORK_TRANSACTION_COMPLETE, // äº‹åŠ¡å¤„ç†å®Œæˆï¼Œéœ€è¦é€šçŸ¥å¯¹æ–¹ã€‚
        BINDER_WORK_NODE, // èŠ‚ç‚¹ç›¸å…³çš„ç®¡ç†æ“ä½œï¼ˆæ¯”å¦‚å¼•ç”¨è®¡æ•°ï¼‰ã€‚
        BINDER_WORK_DEAD_BINDER, // binder å¯¹è±¡æ­»äº¡ï¼Œéœ€è¦é€šçŸ¥æ³¨å†Œäº†æ­»äº¡å›è°ƒçš„è¿›ç¨‹ã€‚
        BINDER_WORK_DEAD_BINDER_AND_CLEAR, // å¯¹è±¡æ­»äº¡å¹¶ä¸”éœ€è¦æ¸…ç†ç›¸å…³èµ„æºã€‚
        BINDER_WORK_CLEAR_DEATH_NOTIFICATION, // éœ€è¦æ¸…é™¤æ­»äº¡é€šçŸ¥ã€‚
    } type;
};
```

è¿™é‡Œæˆ‘æœ‰ä¸¤ä¸ªç–‘é—®ï¼Œç¬¬ä¸€è¿™ä¸ª list_head ç»“æ„æ˜¯å¦‚ä½•å®ç°åŒå‘é“¾è¡¨çš„ï¼Œç¬¬äºŒæ—¢ç„¶è¿™ä¸ª binder_work å¯ä»¥ä»£è¡¨è¿™ä¹ˆå¤šæƒ…å†µï¼Œä½†æ˜¯çœ‹èµ·æ¥å†…å®¹å¾ˆç®€å•ï¼Œå¦‚ä½•æ‰¿è½½æ›´å¤šçš„ä¿¡æ¯å‘¢ï¼Ÿ

å…ˆå›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œlist_head æ˜¯ linux å†…æ ¸ä¸­ä½¿ç”¨éå¸¸æ™®éçš„åŒå‘é“¾è¡¨ç®¡ç†ç»“æ„ï¼Œåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ç‰µæ‰¯åˆ°ä¸€ä¸ªå® container_of.

æˆ‘ä»¬å…ˆä¸¾ä¸ªä¾‹å­ï¼š

```c
// åˆå§‹åŒ–é“¾è¡¨å¤´
struct list_head list;
// INIT_LIST_HEAD(&list);
list.next = &list;
list.prec = &list;

struct binder_work work{.type=BINDER_WORK_TRANSACTION};

list_add(&work->entry, &list);

// éå†

struct binder_work *node;
list_for_each_entry(node, &list, entry){
    printk("type=%d", node->type);
}

```

é¦–å…ˆæˆ‘ä»¬åˆå§‹åŒ–ä¸€ä¸ªé“¾è¡¨å¤´ï¼Œè¿™ä¸ªå¤´çš„ next å’Œ prev éƒ½æŒ‡å‘è‡ªå·±ã€‚éšåæˆ‘ä»¬æ„é€ è‡ªå·±çš„ binder_node, å¹¶é€šè¿‡ list_add æ¥å°† binder_node æ·»åŠ åˆ°é“¾è¡¨ä¸­ï¼Œå…¶å®åªæ˜¯å°† binder_node çš„ entry æ·»åŠ åˆ°é“¾è¡¨ä¸­ã€‚list_add å®ç°å¦‚ä¸‹,å°±æ˜¯ä¸ªç®€å•çš„åŒå‘é“¾è¡¨å¤´æ’æ³•ã€‚

```c
static inline void __list_add(struct list_head *new,
                  struct list_head *prev,
                  struct list_head *next)
{
    next->prev = new;
    new->next = next;
    new->prev = prev;
    prev->next = new;
}

static inline void list_add(struct list_head *new, struct list_head *head)
{
    __list_add(new, head, head->next);
}
```

éšåæˆ‘ä»¬å¯èƒ½ä¼šåœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œéå†ï¼Œåœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œå£°æ˜ä¸€ä¸ªç›®æ ‡ç±»å‹çš„æŒ‡é’ˆï¼Œç”¨æ¥æ‰¿è½½è¿­ä»£è¿‡ç¨‹ä¸­çš„ç›®æ ‡å¯¹è±¡ï¼Œç„¶åè¿™ä¸ª list_for_each_entry ä½¿ç”¨èµ·æ¥å¾ˆç¥å¥‡ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬åˆšå£°æ˜çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é“¾è¡¨åœ°å€ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯list_head åœ¨ä½ çš„ç»“æ„é‡Œé¢çš„å­—æ®µåï¼Œä¾‹å¦‚å¯¹äº binder_node æ¥è¯´ï¼Œå°±æ˜¯ entryã€‚å¯ä»¥çœ‹åˆ°è¿™ä¸ªå®å±•å¼€åå°±æ˜¯ä¸ª for(x;y;z) çš„ç»“æ„ã€‚

- ä½¿ç”¨ list_entry æ¥è·å– entry åªæƒ³çš„ biner_work èŠ‚ç‚¹ï¼Œå¹¶è¿”å›åœ°å€åˆ° posã€‚
- prefetch ä¸éœ€è¦å…³æ³¨ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªä¼˜åŒ–ï¼Œå³å°†å†…å®¹ä¼˜å…ˆåŠ è½½åˆ° L1 ç¼“å­˜ä¸­ã€‚
- pos->next è¿›å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

è¿™é‡Œæœ€æœ‰æ„æ€çš„å°±æ˜¯è¿™ä¸ª list_entry, å¯ä»¥çœ‹åˆ°ä»–æ¥å—çš„æ˜¯ list_head æŒ‡é’ˆã€binder_work ç±»å‹å‚æ•°ã€list_head æŒ‡é’ˆåœ¨ binder_work ç»“æ„ä¸­å¯¹åº”çš„ç»“æ„å entry.

éšå list_entry ç›´æ¥è½¬è°ƒ container_of å®ï¼Œè¿™ä¸ªå®åªåšäº†:

<img src="android/framework/binder/data_struct/resources/2.png" style="width:20%">

- å°† list_head åœ°å€ç±»å‹å…³è”åˆ° binder_work->entryã€‚æ–¹ä¾¿åç»­è¿›è¡ŒæŒ‡é’ˆè®¡ç®—ã€‚
- ä½¿ç”¨ offset è·å– entry å­—æ®µåœ¨ binder_work ä¸­çš„åœ°å€åç§»ã€‚éšåä½¿ç”¨ list_head æŒ‡é’ˆå‡å» è¿™ä¸ªåç§»é‡å°±æ˜¯ binder_work çš„åœ°å€ã€‚

æ›´æœ‰æ„æ€çš„æ˜¯ä¸ºäº†è·å– offsetï¼Œæ˜¯å…ˆå°†åœ°å€ 0 è½¬æ¢æˆ binder_work æŒ‡é’ˆç±»å‹ï¼Œéšåè·å–æˆå‘˜åœ°å€ï¼Œé‚£è¿™æ ·è¿™ä¸ªæˆå‘˜çš„åœ°å€å…¶å®å°±æ˜¯åç§»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯è·å–æˆå‘˜åœ°å€æ“ä½œï¼Œè¿™æ˜¯ä¸€ä¸ªç¼–è¯‘æœŸé€»è¾‘ï¼Œè€Œä¸æ˜¯ç©ºæŒ‡é’ˆè®¿é—®æ•°æ®ï¼Œç©ºæŒ‡é’ˆè®¿é—®ä¼šè§¦å‘æ®µé”™è¯¯ã€‚å¦‚ä½•åŒºåˆ†æ˜¯è·å–æˆå‘˜åœ°å€è¿˜æ˜¯ç©ºæŒ‡é’ˆè®¿é—®ï¼Œæˆ‘ç†è§£åŒºåˆ«å°±åœ¨äºæœ‰æ²¡æœ‰å£°æ˜å¯¹åº”çš„ç±»å‹æŒ‡é’ˆï¼Œå£°æ˜äº†å°±æ˜¯ç©ºæŒ‡é’ˆè®¿é—®ï¼Œå¦åˆ™å°±æ˜¯è·å–åœ°å€æ“ä½œã€‚


```c
// linux/stddef.h
#define offsetof(TYPE, MEMBER) ((size_t) &((TYPE *)0)->MEMBER)

// linux/kernel.h
#define container_of(ptr, type, member) ({			\
    const typeof( ((type *)0)->member ) *Ã§ = (ptr);	\
    (type *)( (char *)__mptr - offsetof(type,member) );})

// linux/list.h
#define list_entry(ptr, type, member) \
    container_of(ptr, type, member)

/**
 * list_for_each_entry	-	iterate over list of given type
 * @pos:	the type * to use as a loop cursor.
 * @head:	the head for your list.
 * @member:	the name of the list_struct within the struct.
 */
#define list_for_each_entry(pos, head, member)				\
    for (pos = list_entry((head)->next, typeof(*pos), member);	\
         prefetch(pos->member.next), &pos->member != (head); 	\
         pos = list_entry(pos->member.next, typeof(*pos), member))
```
ç„¶åæ˜¯ç¬¬äºŒä¸ªé—®é¢˜ï¼Œè¿™ä¹ˆç®€å•çš„ä¸€ä¸ªç»“æ„ä½“æ˜¯å¦‚ä½•æ‰¿è½½ä¸åŒ binder å·¥ä½œé¡¹çš„ä¿¡æ¯çš„ã€‚

å…¶å®è¿™ä¸ª binder_work åªæ˜¯ä¸€ä¸ª"åŸºç±»" æˆ–è€…è¯´æ ‡è¯†ï¼Œå®ƒç”¨æ¥åœ¨çœŸæ­£çš„ binder_work_xxx ä¸­åªæ˜¯ä¸€ä¸ªæˆå‘˜ã€‚

ä¾‹å¦‚ binder_transaction è¿™ä¸ªå­ç±»ã€‚

```c
struct binder_transaction {
    struct binder_work work;   // å¤´éƒ¨ï¼ŒåµŒå…¥äº† binder_work
    // ä¸‹é¢æ˜¯äº‹åŠ¡çš„è¯¦ç»†å†…å®¹
    struct binder_process *from;
    struct binder_thread *from_thread;
    struct binder_transaction *to_parent;
    struct binder_transaction *to_child;
    struct binder_node *to_node;
    struct binder_buffer *buffer;
    unsigned int code;
    unsigned int flags;
    // ... è¿˜æœ‰å¾ˆå¤šå…¶ä»–äº‹åŠ¡ç›¸å…³å­—æ®µ
};
```

### binder_node

ä»£è¡¨ä¸€ä¸ª server ç»„ä»¶çš„å®ä½“å¯¹è±¡ï¼Œæ¯å½“ä¸€ä¸ªè¿›ç¨‹ï¼ˆæ¯”å¦‚ SystemServerï¼‰æŠŠæŸä¸ª binder æœåŠ¡æ³¨å†Œåˆ° binder é©±åŠ¨æ—¶ï¼Œé©±åŠ¨å°±ä¼šä¸ºè¿™ä¸ªæœåŠ¡åˆ†é…ä¸€ä¸ª `binder_node` ç»“æ„ä½“,å°±åƒ SystemService è¿›ç¨‹ä¸€æ ·ï¼Œä¸€ä¸ªè¿›ç¨‹å¯èƒ½æä¾›äº†å¤šä¸ªæœåŠ¡ï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”ç€ä¸€ä¸ª binder_nodeã€‚

```c
struct binder_node {
    int debug_id;
    struct binder_work work;
    union {
        struct rb_node rb_node;
        struct hlist_node dead_node;
    };
    struct binder_proc *proc;
    struct hlist_head refs;
    int internal_strong_refs;
    int local_weak_refs;
    int local_strong_refs;
    void __user *ptr;
    void __user *cookie;
    unsigned has_strong_ref : 1;
    unsigned pending_strong_ref : 1;
    unsigned has_weak_ref : 1;
    unsigned pending_weak_ref : 1;
    unsigned has_async_transaction : 1;
    unsigned accept_fds : 1;
    int min_priority : 8;
    struct list_head async_todo;
};
```
1. **rb_node**
æ¯ä¸ªè¿›ç¨‹ï¼ˆ`binder_proc`ï¼‰å¯èƒ½ä¼šæ³¨å†Œ/æŒæœ‰å¤šä¸ª binder å®ä½“å¯¹è±¡ï¼ˆæ¯”å¦‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ª binder æœåŠ¡ï¼‰ã€‚ä¸ºäº†é«˜æ•ˆç®¡ç†è¿™äº›å¯¹è±¡ï¼Œbinder é©±åŠ¨åœ¨æ¯ä¸ª `binder_proc` é‡Œï¼Œç”¨**çº¢é»‘æ ‘ï¼ˆrbtreeï¼‰**æ¥å­˜å‚¨å’ŒæŸ¥æ‰¾å®ƒæ‰€æ‹¥æœ‰çš„æ‰€æœ‰ `binder_node`ï¼Œæ¯ä¸ª binder_node ä»¥ rb_node çš„å½¢å¼ç§°ä¸ºçº¢é»‘æ ‘çš„èŠ‚ç‚¹ã€‚è‡³äºå¦‚ä½•é€šè¿‡ rb_node å®šä½åˆ° binder_node å‘¢ï¼Ÿ é‚£å°±è¿˜æ˜¯ä¹‹å‰æåˆ°çš„ container_of å®ã€‚

2. **proc**

proc æˆå‘˜æ˜¯ä¸€ä¸ª binder_proc ç±»å‹ï¼ŒæŒ‡å‘çš„æ˜¯æä¾›è¯¥ binder_node çš„è¿›ç¨‹å®ä½“ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`node->proc` è®©ä½ çŸ¥é“â€œè¿™ä¸ª binder æœåŠ¡æ˜¯å“ªä¸ªè¿›ç¨‹æ‹¥æœ‰çš„â€ã€‚

3. **refs**

ä¸€ä¸ªbinderå®ä½“å¯¹è±¡å¯èƒ½ä¼šåŒæ—¶è¢«å¤šä¸ªClientç»„ä»¶å¼•ç”¨ï¼Œå› æ­¤ï¼Œbinderé©±åŠ¨ç¨‹åºå°±ä½¿ç”¨ç»“æ„ä½“binder_refæ¥æè¿°è¿™äº›å¼•ç”¨å…³ç³»ï¼Œå¹¶ä¸”å°†å¼•ç”¨äº†åŒä¸€ä¸ªbinderå®ä½“å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨éƒ½ä¿å­˜åœ¨ä¸€ä¸ªhashåˆ—è¡¨ä¸­ã€‚è¿™ä¸ªhashåˆ—è¡¨é€šè¿‡binderå®ä½“å¯¹è±¡çš„æˆå‘˜å˜é‡refsæ¥æè¿°ï¼Œè€Œbinderé©±åŠ¨ç¨‹åºé€šè¿‡è¿™ä¸ªæˆå‘˜å˜é‡å°±å¯ä»¥çŸ¥é“æœ‰å“ªäº›Clientç»„ä»¶å¼•ç”¨äº†åŒä¸€ä¸ªbinderå®ä½“å¯¹è±¡ã€‚

4. **local_strong_refs, internal_strong_refs, local_weak_refs**

è¿™ä¸‰ä¸ªæˆå‘˜ä»åå­—å¯ä»¥çœ‹å‡ºç”¨æ¥è®°å½•ä¸åŒæ¥æºå¯¹äºè¯¥ binder_node çš„å¼•ç”¨çŠ¶æ€ï¼Œä»è€Œæ§åˆ¶å…¶ç”Ÿå‘½å‘¨æœŸã€‚

- internal_strong_refs:ç»Ÿè®¡binder é©±åŠ¨å†…éƒ¨ï¼ˆæ¯”å¦‚ binder_ref ç»“æ„ä½“ï¼‰å¯¹è¯¥ binder_node çš„å¼ºå¼•ç”¨æ•°é‡ã€‚ä¸»è¦æ¥è‡ªäºå…¶ä»–è¿›ç¨‹é€šè¿‡ handle å¼ºå¼•ç”¨è¯¥ binder æœåŠ¡å¯¹è±¡æ—¶ï¼Œbinder é©±åŠ¨ä¼šå¢åŠ  internal_strong_refsã€‚

- local_strong_refs: ç»Ÿè®¡å®¿ä¸»è¿›ç¨‹å†…éƒ¨å¯¹è¯¥ binder_node çš„å¼ºå¼•ç”¨æ•°é‡ã€‚å½“å®¿ä¸»è¿›ç¨‹å†…éƒ¨æœ‰ Java å±‚å¼ºå¼•ç”¨ï¼ˆæ¯”å¦‚ ServiceManager æŒæœ‰æŸä¸ª Service çš„ Ibinder å¯¹è±¡ï¼‰ï¼Œä¼šå¢åŠ  local_strong_refsã€‚

- local_weak_refs: ç»Ÿè®¡å®¿ä¸»è¿›ç¨‹å†…éƒ¨å¯¹è¯¥ binder_node çš„å¼±å¼•ç”¨æ•°é‡ã€‚å¼±å¼•ç”¨ä¸ä¼šé˜»æ­¢å¯¹è±¡è¢«é”€æ¯ï¼Œåªæ˜¯ç”¨æ¥åˆ¤æ–­â€œæœ‰æ²¡æœ‰äººåœ¨å…³æ³¨è¿™ä¸ªå¯¹è±¡â€ã€‚

5. **ptr, cookie**

ptr å’Œ cookie æŒ‡å‘ä¸¤ä¸ªç”¨æˆ·ç©ºé—´çš„åœ°å€ï¼Œå…¶ä¸­ï¼Œæˆå‘˜å˜é‡cookieæŒ‡å‘è¯¥Serviceç»„ä»¶çš„åœ°å€ï¼Œè€Œæˆå‘˜å˜é‡ptræŒ‡å‘è¯¥Serviceç»„ä»¶å†…éƒ¨çš„ä¸€ä¸ªå¼•ç”¨è®¡æ•°å¯¹è±¡ï¼ˆç±»å‹ä¸ºweakref_implï¼‰çš„åœ°å€ã€‚

6. **has_async_transaction**

è¿™ä¸ªå­—æ®µæ¥è¡¨æ˜å½“å‰ binder_node å³ server ç»„ä»¶æ˜¯ä¸æ˜¯æ­£åœ¨å¤„ç†å¼‚æ­¥äº‹åŠ¡ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œbinderé©±åŠ¨ç¨‹åºéƒ½æ˜¯å°†ä¸€ä¸ªäº‹åŠ¡ä¿å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹çš„ä¸€ä¸ªtodoé˜Ÿåˆ—ä¸­çš„ï¼Œè¡¨ç¤ºè¦ç”±è¯¥çº¿ç¨‹æ¥å¤„ç†è¯¥äº‹åŠ¡ã€‚æ¯ä¸€ä¸ªäº‹åŠ¡éƒ½å…³è”ç€ä¸€ä¸ªbinderå®ä½“å¯¹è±¡ï¼Œè¡¨ç¤ºè¯¥äº‹åŠ¡çš„ç›®æ ‡å¤„ç†å¯¹è±¡ï¼Œå³è¦æ±‚ä¸è¯¥binderå®ä½“å¯¹è±¡å¯¹åº”çš„Serviceç»„ä»¶åœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­å¤„ç†è¯¥äº‹åŠ¡ã€‚ç„¶è€Œï¼Œå½“binderé©±åŠ¨ç¨‹åºå‘ç°ä¸€ä¸ªäº‹åŠ¡æ˜¯å¼‚æ­¥äº‹åŠ¡æ—¶ï¼Œå°±ä¼šå°†å®ƒä¿å­˜åœ¨ç›®æ ‡binderå®ä½“å¯¹è±¡çš„ä¸€ä¸ªå¼‚æ­¥äº‹åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªå¼‚æ­¥äº‹åŠ¡é˜Ÿåˆ—å°±æ˜¯ç”±è¯¥ç›®æ ‡binderå®ä½“å¯¹è±¡çš„æˆå‘˜å˜é‡async_todoæ¥æè¿°çš„ã€‚å¼‚æ­¥äº‹åŠ¡çš„å®šä¹‰æ˜¯é‚£äº›å•å‘çš„è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚ï¼Œå³ä¸éœ€è¦ç­‰å¾…åº”ç­”çš„è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚ï¼Œä¸æ­¤ç›¸å¯¹çš„ä¾¿æ˜¯åŒæ­¥äº‹åŠ¡ã€‚å› ä¸ºä¸éœ€è¦ç­‰å¾…åº”ç­”ï¼Œbinderé©±åŠ¨ç¨‹åºå°±è®¤ä¸ºå¼‚æ­¥äº‹åŠ¡çš„ä¼˜å…ˆçº§ä½äºåŒæ­¥äº‹åŠ¡ï¼Œå…·ä½“å°±è¡¨ç°ä¸ºåœ¨åŒä¸€æ—¶åˆ»ï¼Œä¸€ä¸ªbinderå®ä½“å¯¹è±¡çš„æ‰€æœ‰å¼‚æ­¥äº‹åŠ¡è‡³å¤šåªæœ‰ä¸€ä¸ªä¼šå¾—åˆ°å¤„ç†ï¼Œå…¶ä½™çš„éƒ½ç­‰å¾…åœ¨å¼‚æ­¥äº‹åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè€ŒåŒæ­¥äº‹åŠ¡å°±æ²¡æœ‰è¿™ä¸ªé™åˆ¶ã€‚

7. **work**

binder_node ä¸­æœ‰ä¸€ä¸ª binder_work æˆå‘˜ workï¼Œå°±å¦‚åˆšæ‰è¯´çš„ï¼Œbinder_work ä»£è¡¨ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ node ä¸ºä»€ä¹ˆè¦æŒæœ‰ work å‘¢ï¼Ÿä¸»è¦ç›®çš„æ˜¯è¿›è¡Œç”Ÿå‘½å‘¨æœŸåŒæ­¥ï¼Œå½“ä¸€ä¸ªbinderå®ä½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ç”±0å˜æˆ1ï¼Œæˆ–è€…ç”±1å˜æˆ0æ—¶ï¼Œbinderé©±åŠ¨ç¨‹åºå°±ä¼šè¯·æ±‚ç›¸åº”çš„Serviceç»„ä»¶å¢åŠ æˆ–è€…å‡å°‘å…¶å¼•ç”¨è®¡æ•°ã€‚è¿™æ—¶å€™binderé©±åŠ¨ç¨‹åºå°±ä¼šå°†è¯¥å¼•ç”¨è®¡æ•°ä¿®æ”¹æ“ä½œå°è£…æˆä¸€ä¸ªç±»å‹ä¸ºbinder_nodeçš„å·¥ä½œé¡¹ï¼Œå³å°†ä¸€ä¸ªbinderå®ä½“å¯¹è±¡çš„æˆå‘˜å˜é‡workçš„å€¼è®¾ç½®ä¸ºBINDER_WORK_NODEï¼Œå¹¶ä¸”å°†å®ƒæ·»åŠ åˆ°ç›¸åº”è¿›ç¨‹çš„todoé˜Ÿåˆ—ä¸­å»ç­‰å¾…å¤„ç†ã€‚

8. **min_priority**

ç”¨æ¥æè¿° binder æœåŠ¡æ‰§è¡ŒæœåŠ¡é€»è¾‘æ‰€åœ¨çº¿ç¨‹çš„çº¿ç¨‹ä¼˜å…ˆçº§ã€‚

9. **accept_fds**

accept_fds ç”¨äºæ ‡è®°è¯¥ binder æœåŠ¡å¯¹è±¡æ˜¯å¦å…è®¸æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦ã€‚- åœ¨ binder è·¨è¿›ç¨‹é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œé™¤äº†æ™®é€šçš„æ•°æ®ï¼Œè¿˜å¯ä»¥é€šè¿‡ binder æœºåˆ¶ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ¯”å¦‚ socketã€æ–‡ä»¶ã€ç®¡é“ç­‰ï¼‰ã€‚ä½†æœ‰äº› binder æœåŠ¡å‡ºäºå®‰å…¨æˆ–è®¾è®¡è€ƒè™‘ï¼Œä¸å¸Œæœ›/ä¸å…è®¸æ¥æ”¶ FDï¼Œä»¥é˜²æ­¢èµ„æºæ³„æ¼æˆ–è¢«æ”»å‡»ã€‚ è¿™æ—¶ï¼Œ`accept_fds` å°±ä½œä¸ºä¸€ä¸ªå¼€å…³æ¥æ§åˆ¶ï¼š

- 1/trueï¼šå…è®¸é€šè¿‡ binder ä¼ é€’ FD ç»™è¯¥æœåŠ¡å¯¹è±¡ã€‚
- 0/falseï¼šä¸å…è®¸é€šè¿‡ binder ä¼ é€’ FDï¼Œé©±åŠ¨ä¼šæ‹’ç»æˆ–ä¸¢å¼ƒè¿™ç±»è¯·æ±‚ã€‚

### binder_ref_death

```c
struct binder_ref_death {
    struct binder_work work;
    void __user *cookie;
};
```

ç»“æ„ä½“binder_ref_deathç”¨æ¥æè¿°ä¸€ä¸ªServiceç»„ä»¶çš„æ­»äº¡æ¥æ”¶é€šçŸ¥ã€‚åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªServiceç»„ä»¶è¢«å…¶ä»–Clientè¿›ç¨‹å¼•ç”¨æ—¶ï¼Œå®ƒæ˜¯ä¸å¯ä»¥é”€æ¯çš„ã€‚ç„¶è€Œï¼ŒClientè¿›ç¨‹æ˜¯æ— æ³•æ§åˆ¶å®ƒæ‰€å¼•ç”¨çš„Serviceç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸçš„ï¼Œå› ä¸ºServiceç»„ä»¶æ‰€åœ¨çš„è¿›ç¨‹å¯èƒ½ä¼šæ„å¤–åœ°å´©æºƒï¼Œä»è€Œå¯¼è‡´å®ƒæ„å¤–åœ°æ­»äº¡ã€‚ä¸€ä¸ªæŠ˜ä¸­çš„å¤„ç†åŠæ³•æ˜¯ï¼ŒClientè¿›ç¨‹èƒ½å¤Ÿåœ¨å®ƒæ‰€å¼•ç”¨çš„Serviceç»„ä»¶æ­»äº¡æ—¶è·å¾—é€šçŸ¥ï¼Œä»¥ä¾¿å¯ä»¥åšå‡ºç›¸åº”çš„å¤„ç†ã€‚è¿™æ—¶å€™Clientè¿›ç¨‹å°±éœ€è¦å°†ä¸€ä¸ªç”¨æ¥æ¥æ”¶æ­»äº¡é€šçŸ¥çš„å¯¹è±¡çš„åœ°å€æ³¨å†Œåˆ°binderé©±åŠ¨ç¨‹åºä¸­ã€‚

æˆå‘˜å˜é‡cookieç”¨æ¥ä¿å­˜è´Ÿè´£æ¥æ”¶æ­»äº¡é€šçŸ¥çš„å¯¹è±¡çš„åœ°å€ï¼Œæˆå‘˜å˜é‡workçš„å–å€¼ä¸ºBINDER_WORK_DEAD_BINDERã€BINDER_WORK_CLEAR_DEATH_NOTIFICATIONæˆ–è€…BINDER_WORK_DEAD_BINDER_AND_CLEARï¼Œç”¨æ¥æ ‡å¿—ä¸€ä¸ªå…·ä½“çš„æ­»äº¡é€šçŸ¥ç±»å‹ã€‚

binderé©±åŠ¨ç¨‹åºå†³å®šè¦å‘ä¸€ä¸ªClientè¿›ç¨‹å‘é€ä¸€ä¸ªServiceç»„ä»¶æ­»äº¡é€šçŸ¥æ—¶ï¼Œä¼šå°†ä¸€ä¸ªbinder_ref_deathç»“æ„ä½“å°è£…æˆä¸€ä¸ªå·¥ä½œé¡¹ï¼Œå¹¶ä¸”æ ¹æ®å®é™…æƒ…å†µæ¥è®¾ç½®è¯¥ç»“æ„ä½“çš„æˆå‘˜å˜é‡workçš„å€¼ï¼Œæœ€åå°†è¿™ä¸ªå·¥ä½œé¡¹æ·»åŠ åˆ°Clientè¿›ç¨‹çš„todoé˜Ÿåˆ—ä¸­å»ç­‰å¾…å¤„ç†ã€‚

ä»€ä¹ˆæ—¶å€™ä¼šå‘é€æ­»äº¡é€šçŸ¥å‘¢?

client åœ¨æ³¨å†Œäº†æ­»äº¡ç›‘å¬åï¼Œbinder é©±åŠ¨ä¼šåœ¨ä¸‹é¢ä¸¤ç§åœºæ™¯å‘é€æ­»äº¡é€šçŸ¥ã€‚

- å½“binderé©±åŠ¨ç¨‹åºç›‘æµ‹åˆ°ä¸€ä¸ªServiceç»„ä»¶æ­»äº¡æ—¶ï¼Œå®ƒå°±ä¼šæ‰¾åˆ°è¯¥Serviceç»„ä»¶å¯¹åº”çš„binderå®ä½“å¯¹è±¡ï¼Œç„¶åé€šè¿‡binderå®ä½“å¯¹è±¡çš„æˆå‘˜å˜é‡refså°±å¯ä»¥æ‰¾åˆ°æ‰€æœ‰å¼•ç”¨äº†å®ƒçš„Clientè¿›ç¨‹ï¼Œæœ€åå°±æ‰¾åˆ°è¿™äº›Clientè¿›ç¨‹æ‰€æ³¨å†Œçš„æ­»äº¡æ¥æ”¶é€šçŸ¥ï¼Œå³ä¸€ä¸ªbinder_ref_deathç»“æ„ä½“ã€‚è¿™æ—¶å€™binderé©±åŠ¨ç¨‹åºå°±ä¼šå°†è¯¥binder_ref_deathç»“æ„ä½“æ·»åŠ åˆ°Clientè¿›ç¨‹çš„todoé˜Ÿåˆ—ä¸­å»ç­‰å¾…å¤„ç†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œbinderé©±åŠ¨ç¨‹åºå°†æ­»äº¡é€šçŸ¥çš„ç±»å‹è®¾ç½®ä¸ºBINDER_WORK_DEAD_BINDERã€‚

- å½“Clientè¿›ç¨‹å‘binderé©±åŠ¨ç¨‹åºæ³¨å†Œä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥æ—¶ï¼Œå¦‚æœå®ƒæ‰€å¼•ç”¨çš„Serviceç»„ä»¶å·²ç»æ­»äº¡ï¼Œé‚£ä¹ˆbinderé©±åŠ¨ç¨‹åºå°±ä¼šé©¬ä¸Šå‘é€ä¸€ä¸ªæ­»äº¡é€šçŸ¥ç»™è¯¥Clientè¿›ç¨‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œbinderé©±åŠ¨ç¨‹åºä¹Ÿä¼šå°†æ­»äº¡é€šçŸ¥çš„ç±»å‹è®¾ç½®ä¸ºBINDER_WORK_DEAD_BINDERã€‚


client ä¹Ÿå¯ä»¥æ³¨é”€ä¸€ä¸ªæ­»äº¡ç›‘å¬ï¼Œåœ¨æ³¨é”€çš„æ—¶å€™ï¼Œbinder é©±åŠ¨ä¹Ÿä¼šå‘é€ä¸€ä¸ªç±»å‹ä¸º binder_ref_death çš„å·¥ä½œé¡¹åˆ° client è¿›ç¨‹çš„ todo é˜Ÿåˆ—ä¸­ã€‚

- å¦‚æœClientè¿›ç¨‹åœ¨æ³¨é”€ä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥æ—¶ï¼Œç›¸åº”çš„Serviceç»„ä»¶è¿˜æ²¡æœ‰æ­»äº¡ï¼Œé‚£ä¹ˆbinderé©±åŠ¨ç¨‹åºå°±ä¼šæ‰¾åˆ°ä¹‹å‰æ‰€æ³¨å†Œçš„ä¸€ä¸ªbinder_ref_deathç»“æ„ä½“ï¼Œå¹¶ä¸”å°†å®ƒçš„ç±»å‹workä¿®æ”¹ä¸ºBINDER_WORK_CLEAR_DEATH_NOTIFICATIONï¼Œç„¶åå†å°†è¯¥binder_ref_deathç»“æ„ä½“å°è£…æˆä¸€ä¸ªå·¥ä½œé¡¹æ·»åŠ åˆ°è¯¥Clientè¿›ç¨‹çš„todoé˜Ÿåˆ—ä¸­å»ç­‰å¾…å¤„ç†ã€‚

- å¦‚æœClientè¿›ç¨‹åœ¨æ³¨é”€ä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥æ—¶ï¼Œç›¸åº”çš„Serviceç»„ä»¶å·²ç»æ­»äº¡ï¼Œé‚£ä¹ˆbinderé©±åŠ¨ç¨‹åºå°±ä¼šæ‰¾åˆ°ä¹‹å‰æ‰€æ³¨å†Œçš„ä¸€ä¸ªbinder_ref_deathç»“æ„ä½“ï¼Œå¹¶ä¸”å°†å®ƒçš„ç±»å‹workä¿®æ”¹ä¸ºBINDER_WORK_DEAD_BINDER_AND_CLEARï¼Œç„¶åå†å°†è¯¥binder_ref_deathç»“æ„ä½“å°è£…æˆä¸€ä¸ªå·¥ä½œé¡¹æ·»åŠ åˆ°è¯¥Clientè¿›ç¨‹çš„todoé˜Ÿåˆ—ä¸­å»ç­‰å¾…å¤„ç†ã€‚

### binder_ref

binder_ref ä»£è¡¨ä¸€ä¸ªè¿›ç¨‹å¯¹å¦ä¸€ä¸ªè¿›ç¨‹ binder å®ä½“å¯¹è±¡ (binder_node) çš„å¼•ç”¨ã€‚åœ¨ binder ä½“ç³»ä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹åªèƒ½é€šè¿‡ handleï¼ˆæ•´æ•°å¥æŸ„ï¼‰æ¥å¼•ç”¨åˆ«çš„è¿›ç¨‹çš„ binder æœåŠ¡å¯¹è±¡ï¼Œè€Œä¸èƒ½ç›´æ¥è®¿é—® binder_nodeã€‚handle å’Œ binder_node çš„æ˜ å°„å…³ç³»ï¼Œå°±æ˜¯ç”± `binder_ref` ç»“æ„ä½“æ¥ç»´æŠ¤çš„ã€‚

```c
struct binder_ref {
    /* Lookups needed: */
    /*   node + proc => ref (transaction) */
    /*   desc + proc => ref (transaction, inc/dec ref) */
    /*   node => refs + procs (proc exit) */
    int debug_id;
    struct rb_node rb_node_desc;
    struct rb_node rb_node_node;
    struct hlist_node node_entry; // binder_node ä¼šæœ‰ä¸€ä¸ª hlist_head refs æˆå‘˜ä¿å­˜æ‰€æœ‰å¼•ç”¨äº†ä»–çš„ binder_ref, è¿™ä¸ªnode_entry å°±æ˜¯å¯¹åº”çš„èŠ‚ç‚¹ã€‚
    struct binder_proc *proc;  // æ‹¥æœ‰è¿™ä¸ªå¼•ç”¨çš„è¿›ç¨‹ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯ client æ‰€åœ¨çš„è¿›ç¨‹ã€‚
    struct binder_node *node; // å¼•ç”¨çš„å®ä½“å¯¹è±¡ binder_node
    uint32_t desc;  // å¥æŸ„å€¼æˆ–è€…ç§°ä¸ºæè¿°ç¬¦ï¼Œå®ƒæ˜¯ç”¨æ¥æè¿°ä¸€ä¸ªbinderå¼•ç”¨å¯¹è±¡çš„ã€‚åœ¨Clientè¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´ä¸­ï¼Œä¸€ä¸ªbinderå¼•ç”¨å¯¹è±¡æ˜¯ä½¿ç”¨ä¸€ä¸ªå¥æŸ„å€¼æ¥æè¿°çš„ï¼Œå› æ­¤ï¼Œå½“Clientè¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´é€šè¿‡binderé©±åŠ¨ç¨‹åºæ¥è®¿é—®ä¸€ä¸ªServiceç»„ä»¶æ—¶ï¼Œå®ƒåªéœ€è¦æŒ‡å®šä¸€ä¸ªå¥æŸ„å€¼ï¼Œbinderé©±åŠ¨ç¨‹åºå°±å¯ä»¥é€šè¿‡è¯¥å¥æŸ„å€¼æ‰¾åˆ°å¯¹åº”çš„binderå¼•ç”¨å¯¹è±¡ï¼Œç„¶åå†æ ¹æ®è¯¥binderå¼•ç”¨å¯¹è±¡çš„æˆå‘˜å˜é‡nodeæ‰¾åˆ°å¯¹åº”çš„binderå®ä½“å¯¹è±¡ï¼Œæœ€åå°±å¯ä»¥é€šè¿‡è¯¥binderå®ä½“å¯¹è±¡æ‰¾åˆ°è¦è®¿é—®çš„Serviceç»„ä»¶ã€‚
    int strong;
    int weak;
    struct binder_ref_death *death;
};
```

desc åœ¨ä¸€ä¸ªè¿›ç¨‹èŒƒå›´å†…æ˜¯å”¯ä¸€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä¸åŒçš„è¿›ç¨‹ä¸‹ï¼ŒåŒä¸€ä¸ª desc å¯èƒ½ä»£è¡¨ä¸åŒçš„çš„ binder_nodeã€‚

rb_node_desc å’Œ rb_node_node è¿™ä¸¤ä¸ªéƒ½æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªä¸binder é©±åŠ¨äº¤äº’çš„è¿›ç¨‹ï¼Œéƒ½ä¼šæ„å»ºäº†ä¸¤ä¸ªçº¢é»‘æ ‘(ç»´æŠ¤åœ¨ binder_proc ç»“æ„ä¸­)ï¼Œç¬¬ä¸€ä¸ªä»¥ desc ä¸º key ï¼Œç¬¬äºŒä¸ªä»¥ binder_node ä¸º keyã€‚è¿™æ ·å­ binder é©±åŠ¨å¯ä»¥é«˜æ•ˆçš„ä»¥ desc æˆ–è€… node æ¥æŸ¥æ‰¾åˆ°å¯¹åº”çš„ binder_refã€‚

- ä»¥ desc æŸ¥æ‰¾ï¼Œä¸»è¦ç”¨åœ¨ client å‘èµ·äº‹åŠ¡è¯·æ±‚ã€‚
- ä»¥ node æŸ¥æ‰¾ï¼Œä¸»è¦ç”¨åœ¨æœåŠ¡ç«¯è¿›ç¨‹å‘é€æ­»äº¡é€šçŸ¥ï¼Œå¼•ç”¨ç®¡ç†ç­‰ã€‚

æˆ‘è¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼šrefs_by_node è¿™ä¸ªæœ‰å¿…è¦å—ï¼Œæ¯ä¸€ä¸ª binder_node ä¸æ˜¯ä¼šæŒæœ‰ä¸€ä¸ª refs çš„hash åˆ—è¡¨ï¼Œé‡Œé¢ä¿å­˜ç€æ‰€æœ‰çš„ binder_ref å—ï¼Ÿ

ä¸»è¦æ˜¯ä½¿ç”¨åœºæ™¯ï¼Œrefs è¿™ä¸ª hash åˆ—è¡¨ç”¨äºä¸€ä¸ªä¸€ä¸ª binder_node èŠ‚ç‚¹å¿«é€ŸæŸ¥çœ‹æœ‰å“ªäº›å®ä½“å¼•ç”¨äº†è‡ªå·±ã€‚è€Œ refs_by_node æœåŠ¡çš„æ˜¯ binder_proc, åªéœ€è¦çŸ¥é“ node èŠ‚ç‚¹ï¼Œå°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„å¼•ç”¨ä¿¡æ¯ï¼Œå³æŸ¥æ‰¾è‡ªå·±å¼•ç”¨äº†å“ªäº›å…¶ä½™çš„å®ä½“ã€‚

æœ€åï¼Œdeath å­˜æ”¾çš„æ˜¯æ­»äº¡ç›‘å¬ç»“æ„ä½“ï¼Œç”¨äº server æ­»äº¡åå‘é€æ­»äº¡ç›‘å¬æ—¶æä¾›è¾“å…¥ä¿¡æ¯ã€‚

### binder_buffer

binder_buffer ç”¨æ¥æè¿°ä¸€ä¸ªå†…æ ¸ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºç”¨æ¥è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡æ•°æ®ä¼ è¾“ã€‚æ¯ä¸€ä¸ªä½¿ç”¨ binder rpc çš„è¿›ç¨‹åœ¨å†…æ ¸ä¸­éƒ½æœ‰ä¸€ä¸ªç¼“å†²åŒºé˜Ÿåˆ—ï¼Œæ¯ä¸€ä¸ª binder é€šä¿¡çš„ç¼“å†²åŒºå°±å–è‡ªäºè¿™ä¸ªé˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹å°±æ˜¯ entryã€‚

åŒæ—¶ä¸ºäº†æ›´é«˜æ•ˆçš„ç®¡ç†ï¼Œæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤äº†ä¸¤æ£µçº¢é»‘æ ‘ï¼Œä¸€æ£µæ ‘ç»´æŠ¤çš„æ˜¯åœ¨ä½¿ç”¨ä¸­çš„ bufferï¼Œä¸€é¢—ç»´æŠ¤ç€ç©ºé—²çš„bufferï¼Œfree çš„å€¼ä»£è¡¨å½“å‰æ˜¯ä¸æ˜¯ç©ºé—²ã€‚

æˆå‘˜å˜é‡transactionå’Œtarget_nodeç”¨æ¥æè¿°ä¸€ä¸ªå†…æ ¸ç¼“å†²åŒºæ­£åœ¨äº¤ç»™å“ªä¸€ä¸ªäº‹åŠ¡ä»¥åŠå“ªä¸€ä¸ªbinderå®ä½“å¯¹è±¡ä½¿ç”¨ã€‚

sync_transaction è¡¨æ˜å½“å‰äº‹åŠ¡æ˜¯ä¸æ˜¯å¼‚æ­¥äº‹åŠ¡ï¼Œbinderé©±åŠ¨ç¨‹åºé™åˆ¶äº†åˆ†é…ç»™å¼‚æ­¥äº‹åŠ¡çš„å†…æ ¸ç¼“å†²åŒºçš„å¤§å°ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯åŒæ­¥äº‹åŠ¡å¯ä»¥ä¼˜å…ˆå¾—åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œä»¥ä¾¿å¯ä»¥å¿«é€Ÿåœ°å¯¹è¯¥åŒæ­¥äº‹åŠ¡è¿›è¡Œå¤„ç†ã€‚

```c
struct binder_buffer {
    struct list_head entry; /* free and allocated entries by addesss */
    struct rb_node rb_node; /* free entry by size or allocated entry */
                /* by address */
    unsigned free : 1;
    unsigned allow_user_free : 1; // server åœ¨å¤„ç†å®Œæˆäº‹åŠ¡åï¼Œæ˜¯å¦å¯ä»¥å†³å®šé‡Šæ”¾ç¼“å†²åŒºã€‚
    unsigned async_transaction : 1; // å¦‚æœå½“å‰äº‹åŠ¡æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹åŠ¡ï¼Œè¿™ä¸ªä½ç½®ä¼šè®¾ç½®æˆ 1
    unsigned debug_id : 29;

    struct binder_transaction *transaction;

    struct binder_node *target_node;
    size_t data_size;
    size_t offsets_size;
    uint8_t data[0];
};
```

æˆå‘˜å˜é‡dataæŒ‡å‘ä¸€å—å¤§å°å¯å˜çš„æ•°æ®ç¼“å†²åŒºï¼Œå®ƒæ˜¯çœŸæ­£ç”¨æ¥ä¿å­˜é€šä¿¡æ•°æ®çš„ã€‚æ•°æ®ç¼“å†²åŒºä¿å­˜çš„æ•°æ®åˆ’åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œå…¶ä¸­ä¸€ç§æ˜¯æ™®é€šæ•°æ®ï¼Œå¦ä¸€ç§æ˜¯binderå¯¹è±¡ã€‚

binderé©±åŠ¨ç¨‹åºä¸å…³å¿ƒæ•°æ®ç¼“å†²åŒºä¸­çš„æ™®é€šæ•°æ®ï¼Œä½†æ˜¯å¿…é¡»è¦çŸ¥é“é‡Œé¢çš„binderå¯¹è±¡ï¼Œå› ä¸ºå®ƒéœ€è¦æ ¹æ®å®ƒä»¬æ¥ç»´æŠ¤å†…æ ¸ä¸­çš„binderå®ä½“å¯¹è±¡å’Œbinderå¼•ç”¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ•°æ®ç¼“å†²åŒºä¸­åŒ…å«äº†ä¸€ä¸ªbinderå¼•ç”¨ï¼Œå¹¶ä¸”è¯¥æ•°æ®ç¼“å†²åŒºæ˜¯ä¼ é€’ç»™å¦å¤–ä¸€ä¸ªè¿›ç¨‹çš„ï¼Œé‚£ä¹ˆbinderé©±åŠ¨ç¨‹åºå°±éœ€è¦ä¸ºå¦å¤–ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºä¸€ä¸ªbinderå¼•ç”¨å¯¹è±¡ï¼Œå¹¶ä¸”å¢åŠ ç›¸åº”çš„binderå®ä½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå› ä¸ºå®ƒä¹Ÿè¢«å¦å¤–çš„è¿™ä¸ªè¿›ç¨‹å¼•ç”¨äº†ã€‚

ç”±äºæ•°æ®ç¼“å†²åŒºä¸­çš„æ™®é€šæ•°æ®å’Œbinderå¯¹è±¡æ˜¯æ··åˆåœ¨ä¸€èµ·ä¿å­˜çš„ï¼Œå®ƒä»¬ä¹‹é—´å¹¶æ²¡æœ‰å›ºå®šçš„é¡ºåºï¼Œå› æ­¤ï¼Œbinderé©±åŠ¨ç¨‹åºå°±éœ€è¦é¢å¤–çš„æ•°æ®æ¥æ‰¾åˆ°é‡Œé¢çš„binderå¯¹è±¡ã€‚åœ¨æ•°æ®ç¼“å†²åŒºçš„åé¢ï¼Œæœ‰ä¸€ä¸ªåç§»æ•°ç»„ï¼Œå®ƒè®°å½•äº†æ•°æ®ç¼“å†²åŒºä¸­æ¯ä¸€ä¸ªbinderå¯¹è±¡åœ¨æ•°æ®ç¼“å†²åŒºä¸­çš„ä½ç½®ã€‚åç§»æ•°ç»„çš„å¤§å°ä¿å­˜åœ¨æˆå‘˜å˜é‡offsets_sizeä¸­ï¼Œè€Œæ•°æ®ç¼“å†²åŒºçš„å¤§å°ä¿å­˜åœ¨æˆå‘˜å˜é‡data_sizeä¸­ã€‚


### binder_proc

ç»“æ„ä½“binder_procç”¨æ¥æè¿°ä¸€ä¸ªæ­£åœ¨ä½¿ç”¨binderè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶çš„è¿›ç¨‹ã€‚å½“ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨å‡½æ•°openæ¥æ‰“å¼€è®¾å¤‡æ–‡ä»¶/dev/binderæ—¶ï¼Œbinderé©±åŠ¨ç¨‹åºå°±ä¼šä¸ºå®ƒåˆ›å»ºä¸€ä¸ªbinder_procç»“æ„ä½“ï¼Œå¹¶ä¸”å°†å®ƒä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„hashåˆ—è¡¨ä¸­ï¼Œè€Œæˆå‘˜å˜é‡proc_nodeå°±æ­£å¥½æ˜¯è¯¥hashåˆ—è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚

æ­¤å¤–ï¼Œæˆå‘˜å˜é‡pidã€tskå’Œfilesåˆ†åˆ«æŒ‡å‘äº†è¿›ç¨‹çš„è¿›ç¨‹ç»„IDã€ä»»åŠ¡æ§åˆ¶å—(ğŸ˜¯ï¼ŒPCB!)å’Œæ‰“å¼€æ–‡ä»¶ç»“æ„ä½“æ•°ç»„ã€‚

åœ¨æ‰“å¼€äº† binder è®¾å¤‡æ–‡ä»¶çš„è¿›ç¨‹ä¸­ï¼Œä¸€èˆ¬åç»­è¿˜éœ€è¦ mmapï¼Œæˆ‘ä»¬å¯¹äºæ™®é€šæ–‡æœ¬æ–‡ä»¶è¿›è¡Œ mmap æ“ä½œå’Œå¯¹ binder æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¯¹äºä¸€ä¸ªæ™®é€šçš„æ–‡æœ¬æ–‡ä»¶ï¼Œmmap ç”±å†…æ ¸è¿›è¡Œå¤„ç†ã€‚è€Œå¯¹äº binderï¼Œmmap ä¼šè§¦å‘ binder é©±åŠ¨æ³¨å†Œçš„ .mmap å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¿›è¡Œå®é™…çš„ mmap åŠ¨ä½œã€‚æ”¾åœ¨ binder è¿™é‡Œï¼Œå°±æ˜¯ binder é©±åŠ¨ç¨‹åºä¸ºå®ƒåˆ†é…ä¸€å—å†…æ ¸ç¼“å†²åŒºï¼Œä»¥ä¾¿å¯ä»¥ç”¨æ¥åœ¨è¿›ç¨‹é—´ä¼ è¾“æ•°æ®ã€‚

binder é©±åŠ¨ç¨‹åºä¸ºè¿›ç¨‹åˆ†é…çš„å†…æ ¸ç¼“å†²åŒºçš„å¤§å°ä¿å­˜åœ¨æˆå‘˜å˜é‡ buffer_size ä¸­ã€‚è¿™äº›å†…æ ¸ç¼“å†²åŒºæœ‰ä¸¤ä¸ªåœ°å€ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å†…æ ¸ç©ºé—´åœ°å€ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ç”¨æˆ·ç©ºé—´åœ°å€ã€‚å†…æ ¸ç©ºé—´åœ°å€æ˜¯åœ¨ binder é©±åŠ¨ç¨‹åºå†…éƒ¨ä½¿ç”¨çš„ï¼Œä¿å­˜åœ¨æˆå‘˜å˜é‡buffer ä¸­ï¼Œè€Œç”¨æˆ·ç©ºé—´åœ°å€æ˜¯åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹å†…éƒ¨ä½¿ç”¨çš„ï¼Œä¿å­˜åœ¨æˆå‘˜å˜é‡ vma ä¸­ã€‚è¿™ä¸¤ä¸ªåœ°å€ç›¸å·®ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œä¿å­˜åœ¨æˆå‘˜å˜é‡ user_buffer_offset ä¸­ã€‚è¿™æ ·ï¼Œç»™å®šä¸€ä¸ªç”¨æˆ·ç©ºé—´åœ°å€æˆ–è€…ä¸€ä¸ªå†…æ ¸ç©ºé—´åœ°å€ï¼Œbinder é©±åŠ¨ç¨‹åºå°±å¯ä»¥è®¡ç®—å‡ºå¦å¤–ä¸€ä¸ªåœ°å€çš„å¤§å°ã€‚

å½“è¿›ç¨‹æ¥æ”¶åˆ°ä¸€ä¸ªè¿›ç¨‹é—´é€šä¿¡è¯·æ±‚æ—¶ï¼Œbinder é©±åŠ¨ç¨‹åºå°±å°†è¯¥è¯·æ±‚å°è£…æˆä¸€ä¸ªå·¥ä½œé¡¹ï¼Œå¹¶ä¸”åŠ å…¥åˆ°è¿›ç¨‹çš„å¾…å¤„ç†å·¥ä½œé¡¹é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä½¿ç”¨æˆå‘˜å˜é‡ todo æ¥æè¿°ã€‚

binderçº¿ç¨‹æ± ä¸­çš„ç©ºé—²binderçº¿ç¨‹ä¼šç¡çœ åœ¨ç”±æˆå‘˜å˜é‡waitæ‰€æè¿°çš„ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå½“å®ƒä»¬çš„å®¿ä¸»è¿›ç¨‹çš„å¾…å¤„ç†å·¥ä½œé¡¹é˜Ÿåˆ—å¢åŠ äº†æ–°çš„å·¥ä½œé¡¹ä¹‹åï¼Œbinderé©±åŠ¨ç¨‹åºå°±ä¼šå”¤é†’è¿™äº›çº¿ç¨‹ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥å»å¤„ç†æ–°çš„å·¥ä½œé¡¹ã€‚

ä¸€ä¸ªè¿›ç¨‹å†…éƒ¨åŒ…å«äº†ä¸€ç³»åˆ—çš„binderå®ä½“å¯¹è±¡å’Œbinderå¼•ç”¨å¯¹è±¡ï¼Œè¿›ç¨‹ä½¿ç”¨ä¸‰ä¸ªçº¢é»‘æ ‘æ¥ç»„ç»‡å®ƒä»¬ï¼Œå…¶ä¸­ï¼Œæˆå‘˜å˜é‡nodesæ‰€æè¿°çš„çº¢é»‘æ ‘æ˜¯ç”¨æ¥ç»„ç»‡binderå®ä½“å¯¹è±¡çš„ï¼Œå®ƒä»¥binderå®ä½“å¯¹è±¡çš„æˆå‘˜å˜é‡pträ½œä¸ºå…³é”®å­—ï¼›è€Œæˆå‘˜å˜é‡refs_by_descå’Œrefs_by_nodeæ‰€æè¿°çš„çº¢é»‘æ ‘æ˜¯ç”¨æ¥ç»„ç»‡binderå¼•ç”¨å¯¹è±¡çš„ï¼Œå‰è€…ä»¥binderå¼•ç”¨å¯¹è±¡çš„æˆå‘˜å˜é‡descä½œä¸ºå…³é”®å­—ï¼Œè€Œåè€…ä»¥binderå¼•ç”¨å¯¹è±¡çš„æˆå‘˜å˜é‡nodeä½œä¸ºå…³é”®å­—ã€‚

è€Œæˆå‘˜å˜é‡refs_by_descå’Œrefs_by_nodeæ‰€æè¿°çš„çº¢é»‘æ ‘æ˜¯ç”¨æ¥ç»„ç»‡binderå¼•ç”¨å¯¹è±¡çš„ï¼Œå‰è€…ä»¥binderå¼•ç”¨å¯¹è±¡çš„æˆå‘˜å˜é‡descä½œä¸ºå…³é”®å­—ï¼Œè€Œåè€…ä»¥binderå¼•ç”¨å¯¹è±¡çš„æˆå‘˜å˜é‡nodeä½œä¸ºå…³é”®å­—ã€‚

```c
struct binder_proc {
    struct hlist_node proc_node;
    struct rb_root threads;						// æ¯ä¸€ä¸ª binder è¿›ç¨‹è¿›ç¨‹é—´é€šä¿¡éƒ½ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥å¤„ç†ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯çº¿ç¨‹æ± çš„çº¢é»‘æ ‘æ ¹èŠ‚ç‚¹ï¼Œkey æ˜¯ tidã€‚
    struct rb_root nodes;						// ä¿å­˜ç€è¿›ç¨‹æŒæœ‰çš„æ‰€æœ‰ binder_node å¯¹è±¡, ä»¥ node çš„ ptr æˆå‘˜ä¸º keyã€‚
    struct rb_root refs_by_desc;
    struct rb_root refs_by_node;
    int pid;  									// è¿›ç¨‹ç»„ID
    struct vm_area_struct *vma;					// mmap åï¼Œbinder ç¼“å†²åŒºæ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´çš„åœ°å€
    struct task_struct *tsk;					// ä»»åŠ¡æ§åˆ¶å—
    struct files_struct *files;					// æ–‡ä»¶ç»“æ„ä½“æ•°ç»„
    struct hlist_node deferred_work_node;		// ä¸€äº›å¯ä»¥å»¶è¿Ÿæ‰§è¡Œçš„å·¥ä½œé¡¹
    int deferred_work;							// ä¸€ä¸ª flagï¼Œç”±æ‰€æœ‰çš„å»¶è¿Ÿç±»å‹ä»»åŠ¡ç»„åˆèµ·æ¥ï¼Œç”¨æ¥è¡¨ç¤ºå½“å‰è¿›ç¨‹æœ‰å“ªäº›ç±»å‹çš„å»¶è¿Ÿä»»åŠ¡
    void *buffer;								// mmap åï¼Œbinder ç¼“å†²åŒºå†…æ ¸ç©ºé—´åœ°å€
    ptrdiff_t user_buffer_offset;				// binder ç¼“å†²åŒº å†…æ ¸ç©ºé—´åœ°å€å’Œç”¨æˆ·ç©ºé—´åœ°å€çš„åç§»é‡

    struct list_head buffers;					// å¯¹ buffer ç¼“å†²åŒºè¿›è¡Œåˆ’åˆ†å°å—ï¼Œæ¯ä¸€ä¸ªå°±æ˜¯ä¸€ä¸ª binder_buffer ç»“æ„ä½“ã€‚æ•´ä½“æ˜¯ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ª buffers å°±æ˜¯é“¾è¡¨å¤´ã€‚
    struct rb_root free_buffers;				// çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œä¿å­˜çš„æ˜¯æ‰€æœ‰æ²¡æœ‰ä½¿ç”¨åˆ°çš„ binder_buffer. ç›®çš„æ˜¯ä¸ºäº†æ›´é«˜æ•ˆçš„æŸ¥æ‰¾ã€‚key æ˜¯ buffer çš„å¤§å°ã€‚
    struct rb_root allocated_buffers;			// çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œä¿å­˜çš„æ˜¯æ‰€æœ‰æ­£åœ¨ä½¿ç”¨åˆ°çš„ binder_buffer. ç›®çš„æ˜¯ä¸ºäº†æ›´é«˜æ•ˆçš„æŸ¥æ‰¾ã€‚key æ˜¯ buffer çš„åœ°å€ã€‚
    size_t free_async_space;

    struct page **pages;						// ç‰©ç†é¡µé¢åœ°å€å­˜å‚¨
    size_t buffer_size;
    uint32_t buffer_free;
    struct list_head todo;						// è¯¥è¿›ç¨‹å¾…å¤„ç†å·¥ä½œåºåˆ—
    wait_queue_head_t wait;						// ç©ºé—²çš„å¯ä»¥å¤„ç†ä»»åŠ¡çš„ç­‰å¾…é˜Ÿåˆ—
    struct binder_stats stats;
    struct list_head delivered_death;
    int max_threads;
    int requested_threads;
    int requested_threads_started;
    int ready_threads;
    long default_priority;
};
```

æˆå‘˜å˜é‡deferred_work_nodeæ˜¯ä¸€ä¸ªhashåˆ—è¡¨ï¼Œç”¨æ¥ä¿å­˜è¿›ç¨‹å¯ä»¥å»¶è¿Ÿæ‰§è¡Œçš„å·¥ä½œé¡¹ã€‚è¿™äº›å»¶è¿Ÿå·¥ä½œé¡¹æœ‰ä¸‰ç§ç±»å‹ï¼Œå¦‚ä¸‹æ‰€ç¤º:

é¦–å…ˆæ˜ç¡®çš„æ˜¯ï¼Œè¿™ä¸‰ç§å»¶è¿Ÿä»»åŠ¡éƒ½æ˜¯ç”± binder é©±åŠ¨å†…æ ¸å»åšçš„ï¼Œè€Œä¸æ˜¯å’Œ todo ä¸€æ ·åˆ†å‘ç»™è¿›ç¨‹å»åšã€‚

- BINDER_DEFERRED_PUT_FILES: å½“è¿›ç¨‹é€šè¿‡ binder ä¼ é€’äº†æ–‡ä»¶æè¿°ç¬¦ï¼Œå†…æ ¸éœ€è¦åœ¨æ¶ˆæ¯ä¼ é€’å®Œæˆåï¼Œé€‚æ—¶åœ°å…³é—­æˆ–é‡Šæ”¾è¿™äº›æ–‡ä»¶æè¿°ç¬¦ã€‚æœ‰æ—¶ä¸èƒ½ç«‹åˆ»é‡Šæ”¾ï¼ˆæ¯”å¦‚è¿˜åœ¨è¢«ä½¿ç”¨ï¼‰ï¼Œæ‰€ä»¥ä¼šæŠŠâ€œé‡Šæ”¾æ–‡ä»¶æè¿°ç¬¦â€è¿™ä¸ªæ“ä½œå»¶è¿Ÿåˆ°åˆé€‚æ—¶æœºï¼ˆæ¯”å¦‚æ¶ˆæ¯å¤„ç†å®Œæˆåï¼‰ã€‚
- BINDER_DEFERRED_FLUSH: â€œFlushâ€ æ„ä¸ºâ€œåˆ·æ–°â€ï¼Œåœ¨ binder é©±åŠ¨ä¸­ï¼Œé€šå¸¸æŒ‡çš„æ˜¯æŠŠç§¯ç´¯çš„æ¶ˆæ¯ã€å‘½ä»¤ç­‰æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºåˆ·æ–°åˆ°ç›®æ ‡è¿›ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚æœ‰æ—¶å‡ºäºæ•ˆç‡æˆ–åŒæ­¥çš„è€ƒè™‘ï¼Œä¸ä¼šæ¯æ¬¡æ¶ˆæ¯åˆ°è¾¾éƒ½ç«‹å³åˆ·æ–°ï¼Œè€Œæ˜¯å»¶è¿Ÿåˆ°åˆé€‚æ—¶æœºæ‰¹é‡å¤„ç†ã€‚
- BINDER_DEFERRED_RELEASE: å½“è¿›ç¨‹é€€å‡ºã€æ–­å¼€ binder è¿æ¥æˆ–æŸäº›èµ„æºä¸å†éœ€è¦æ—¶ï¼Œbinder é©±åŠ¨éœ€è¦æ¸…ç†å’Œé‡Šæ”¾ç›¸å…³èµ„æºã€‚ç”±äºèµ„æºé‡Šæ”¾å¯èƒ½æ¶‰åŠå¤æ‚çš„ä¾èµ–å…³ç³»ï¼ˆæ¯”å¦‚è¿˜æœ‰å…¶ä»–è¿›ç¨‹å¼•ç”¨ï¼‰ï¼Œæˆ–è€…ä¸ºäº†é¿å…åœ¨å…³é”®è·¯å¾„ä¸Šé˜»å¡ï¼Œbinder é©±åŠ¨ä¼šæŠŠè¿™äº›é‡Šæ”¾æ“ä½œå»¶è¿Ÿåˆ°åç»­ç»Ÿä¸€å¤„ç†ã€‚

```c
enum {
    BINDER_DEFERRED_PUT_FILES    = 0x01,
    BINDER_DEFERRED_FLUSH        = 0x02,
    BINDER_DEFERRED_RELEASE      = 0x04,
};
```

### binder_thread

binder_thread ç”¨æ¥æè¿° binder çº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œproc æŒ‡å‘å…¶å®¿ä¸»è¿›ç¨‹ binder_proc, rb_node æ˜¯ proc ä¸­ threads çº¢é»‘æ ‘çš„èŠ‚ç‚¹ã€‚

```c
struct binder_thread {
    struct binder_proc *proc;
    struct rb_node rb_node;
    int pid; // çº¿ç¨‹ idï¼Œè¿™é‡Œå› ä¸º linux ä¸‹çº¿ç¨‹å’Œè¿›ç¨‹çš„å½¢å¼å·®ä¸å¤šï¼Œæ‰€ä»¥è¿™é‡Œçš„åå­—ä¹Ÿå°±å« pidã€‚
    int looper;
    struct binder_transaction *transaction_stack;
    struct list_head todo;
    uint32_t return_error; /* Write failed, return error code in read buf */
    uint32_t return_error2; /* Write failed, return error code in read */
        /* buffer. Used when sending a reply to a dead process that */
        /* we are also waiting on */
    wait_queue_head_t wait;
    struct binder_stats stats;
};
```

binder_thread ä¸€ä¸ªçº¿ç¨‹ä¸€èˆ¬ä¼šä¸æ–­çš„å¾ªç¯ç­‰å¾…å¤„ç† binder æ¶ˆæ¯ï¼Œæ‰€ä»¥ä¸ºäº†æè¿°è¿™ä¸ªå¾ªç¯ç­‰å¾…çš„çŠ¶æ€ï¼Œå¼•å…¥äº†ä¸€ä¸ªæˆå‘˜ looperï¼Œæœ‰ä¸‹é¢å‡ ç§ç±»å‹ï¼Œç°åœ¨è¿™äº›çŠ¶æ€çš„å«ä¹‰å…ˆæŒ‰ä¸‹ä¸è¡¨ï¼Œç­‰åé¢å­¦ä¹  binder é©±åŠ¨æµç¨‹çš„æ—¶å€™è‡ªç„¶å°±ä¼šæåˆ°ã€‚

```c
enum {
    BINDER_LOOPER_STATE_REGISTERED  = 0x01,
    BINDER_LOOPER_STATE_ENTERED     = 0x02,
    BINDER_LOOPER_STATE_EXITED      = 0x04,
    BINDER_LOOPER_STATE_INVALID     = 0x08,
    BINDER_LOOPER_STATE_WAITING     = 0x10,
    BINDER_LOOPER_STATE_NEED_RETURN = 0x20
};
```

å½“ä¸€ä¸ªæ¥è‡ª Client è¿›ç¨‹çš„è¯·æ±‚æŒ‡å®šè¦ç”±æŸä¸€ä¸ª binder çº¿ç¨‹æ¥å¤„ç†æ—¶ï¼Œè¿™ä¸ªè¯·æ±‚å°±ä¼šåŠ å…¥åˆ°ç›¸åº”çš„ binder_thread ç»“æ„ä½“çš„æˆå‘˜å˜é‡ todo æ‰€è¡¨ç¤ºçš„é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”ä¼šå”¤é†’è¿™ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œå› ä¸ºè¿™æ—¶å€™è¿™ä¸ªçº¿ç¨‹å¯èƒ½å¤„äºç¡çœ çŠ¶æ€ã€‚

å½“ binder é©±åŠ¨ç¨‹åºå†³å®šå°†ä¸€ä¸ªäº‹åŠ¡äº¤ç»™ä¸€ä¸ª binder çº¿ç¨‹å¤„ç†æ—¶ï¼Œå®ƒå°±ä¼šå°†è¯¥äº‹åŠ¡å°è£…æˆä¸€ä¸ª binder_transaction ç»“æ„ä½“ï¼Œå¹¶ä¸”å°†å®ƒæ·»åŠ åˆ°ç”±çº¿ç¨‹ç»“æ„ä½“ binder_thread çš„æˆå‘˜å˜é‡ transaction_stack æ‰€æè¿°çš„ä¸€ä¸ªäº‹åŠ¡å †æ ˆä¸­

å½“ä¸€ä¸ª binder çº¿ç¨‹åœ¨å¤„ç†ä¸€ä¸ªäº‹åŠ¡ T1 å¹¶éœ€è¦ä¾èµ–äºå…¶ä»–çš„ binder çº¿ç¨‹æ¥å¤„ç†å¦å¤–ä¸€ä¸ªäº‹åŠ¡ T2 æ—¶ï¼Œå®ƒå°±ä¼šç¡çœ åœ¨ç”±æˆå‘˜å˜é‡ wait æ‰€æè¿°çš„ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°äº‹åŠ¡ T2 å¤„ç†å®Œæˆä¸ºæ­¢ã€‚

ä¸€ä¸ª binder çº¿ç¨‹åœ¨å¤„ç†ä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œå¦‚æœå‡ºç°äº†å¼‚å¸¸æƒ…å†µï¼Œé‚£ä¹ˆ Binde ré©±åŠ¨ç¨‹åºå°±ä¼šå°†ç›¸åº”çš„é”™è¯¯ç ä¿å­˜åœ¨å…¶æˆå‘˜å˜é‡ return_error å’Œ reutrn_error2 ä¸­ï¼Œè¿™æ—¶å€™çº¿ç¨‹å°±ä¼šå°†è¿™äº›é”™è¯¯è¿”å›ç»™ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºå¤„ç†ã€‚


### binder_transaction

binder_transaction æ˜¯ binder_work çš„ä¸€ä¸ªå®ç°ï¼Œä¹Ÿå°±æ˜¯ "å­ç±»"ã€‚å½“ binder é©±åŠ¨ç¨‹åºä¸ºç›®æ ‡è¿›ç¨‹æˆ–è€…ç›®æ ‡çº¿ç¨‹åˆ›å»ºä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œå°±ä¼šå°†è¯¥äº‹åŠ¡çš„æˆå‘˜å˜é‡ work çš„å€¼è®¾ç½®ä¸º BINDER_WORK_TRANSACTIONï¼Œå¹¶ä¸”å°†å®ƒæ·»åŠ åˆ°ç›®æ ‡è¿›ç¨‹æˆ–è€…ç›®æ ‡çº¿ç¨‹çš„ todo é˜Ÿåˆ—ä¸­å»ç­‰å¾…å¤„ç†ã€‚

æˆå‘˜å˜é‡ need_reply ç”¨æ¥åŒºåˆ†ä¸€ä¸ªäº‹åŠ¡æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ã€‚åŒæ­¥äº‹åŠ¡éœ€è¦ç­‰å¾…å¯¹æ–¹å›å¤ï¼Œè¿™æ—¶å€™å®ƒçš„æˆå‘˜å˜é‡ need_reply çš„å€¼å°±ä¼šè®¾ç½®ä¸º 1ï¼›å¦åˆ™å°±è®¾ç½®ä¸º 0ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹åŠ¡ï¼Œä¸éœ€è¦ç­‰å¾…å›å¤ã€‚

```c
struct binder_transaction {
    int debug_id;
    struct binder_work work;
    struct binder_thread *from;
    struct binder_transaction *from_parent;
    struct binder_proc *to_proc;
    struct binder_thread *to_thread;
    struct binder_transaction *to_parent;
    unsigned need_reply : 1;
    /*unsigned is_dead : 1;*/ /* not used at the moment */

    struct binder_buffer *buffer;
    unsigned int	code;
    unsigned int	flags;
    long	priority;		// æºçº¿ç¨‹ä¼˜å…ˆçº§
    long	saved_priority; // binder é©±åŠ¨
    uid_t	sender_euid;
};
```

æˆå‘˜å˜é‡ from æŒ‡å‘å‘èµ·äº‹åŠ¡çš„çº¿ç¨‹ï¼Œç§°ä¸ºæºçº¿ç¨‹ï¼›æˆå‘˜å˜é‡ to_proc å’Œ to_thread åˆ†åˆ«æŒ‡å‘è´Ÿè´£å¤„ç†è¯¥äº‹åŠ¡çš„è¿›ç¨‹å’Œçº¿ç¨‹ï¼Œç§°ä¸ºç›®æ ‡è¿›ç¨‹å’Œç›®æ ‡çº¿ç¨‹ã€‚

æˆå‘˜å˜é‡ priority å’Œ sender_euid åˆ†åˆ«ç”¨æ¥æè¿°æºçº¿ç¨‹çš„ä¼˜å…ˆçº§å’Œç”¨æˆ· IDã€‚é€šè¿‡è¿™ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œç›®æ ‡è¿›ç¨‹æˆ–è€…ç›®æ ‡çº¿ç¨‹å°±å¯ä»¥è¯†åˆ«äº‹åŠ¡å‘èµ·æ–¹çš„èº«ä»½ã€‚

ä¸€ä¸ªçº¿ç¨‹åœ¨å¤„ç†ä¸€ä¸ªäº‹åŠ¡æ—¶ï¼ŒBinderé©±åŠ¨ç¨‹åºéœ€è¦ä¿®æ”¹å®ƒçš„çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œä»¥ä¾¿æ»¡è¶³æºçº¿ç¨‹å’Œç›®æ ‡ Service ç»„ä»¶çš„è¦æ±‚ã€‚Binder é©±åŠ¨ç¨‹åºåœ¨ä¿®æ”¹ä¸€ä¸ªçº¿ç¨‹çš„ä¼˜å…ˆçº§ä¹‹å‰ï¼Œä¼šå°†å®ƒåŸæ¥çš„çº¿ç¨‹ä¼˜å…ˆçº§ä¿å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ç»“æ„ä½“çš„æˆå‘˜å˜é‡ saved_priority ä¸­ï¼Œä»¥ä¾¿çº¿ç¨‹å¤„ç†å®Œæˆè¯¥äº‹åŠ¡åå¯ä»¥æ¢å¤åŸæ¥çš„ä¼˜å…ˆçº§ã€‚

æˆå‘˜å˜é‡ buffer æŒ‡å‘ Binder é©±åŠ¨ç¨‹åºä¸ºè¯¥äº‹åŠ¡åˆ†é…çš„ä¸€å—å†…æ ¸ç¼“å†²åŒºï¼Œå®ƒé‡Œé¢ä¿å­˜äº†è¿›ç¨‹é—´é€šä¿¡æ•°æ®ã€‚

æˆå‘˜å˜é‡ from_parent å’Œ to_parent åˆ†åˆ«æè¿°ä¸€ä¸ªäº‹åŠ¡æ‰€ä¾èµ–çš„å¦å¤–ä¸€ä¸ªäº‹åŠ¡ï¼Œä»¥åŠç›®æ ‡çº¿ç¨‹ä¸‹ä¸€ä¸ªéœ€è¦å¤„ç†çš„äº‹åŠ¡ã€‚

å‡è®¾çº¿ç¨‹Aå‘èµ·äº†ä¸€ä¸ªäº‹åŠ¡T1ï¼Œéœ€è¦ç”±çº¿ç¨‹Bæ¥å¤„ç†ï¼›çº¿ç¨‹Båœ¨å¤„ç†äº‹åŠ¡T1æ—¶ï¼Œåˆéœ€è¦çº¿ç¨‹Cå…ˆå¤„ç†äº‹åŠ¡T2ï¼›çº¿ç¨‹Cåœ¨å¤„ç†äº‹åŠ¡T2æ—¶ï¼Œåˆéœ€è¦çº¿ç¨‹Aå…ˆå¤„ç†äº‹åŠ¡T3ã€‚è¿™æ ·ï¼Œäº‹åŠ¡T1å°±ä¾èµ–äºäº‹åŠ¡T2ï¼Œè€Œäº‹åŠ¡T2åˆä¾èµ–äºäº‹åŠ¡T3ï¼Œå®ƒä»¬çš„å…³ç³»å¦‚ä¸‹ï¼š

```c
T2-ï¼from_parent=T1;
T3-ï¼from_parent=T2;
```

å¯¹äºçº¿ç¨‹Aæ¥è¯´ï¼Œå®ƒéœ€è¦å¤„ç†çš„äº‹åŠ¡æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯T1å’ŒT3ï¼Œå®ƒé¦–å…ˆè¦å¤„ç†äº‹åŠ¡T3ï¼Œç„¶åæ‰èƒ½å¤„ç†äº‹åŠ¡T1ï¼Œå› æ­¤ï¼Œäº‹åŠ¡T1å’ŒT3çš„å…³ç³»å¦‚ä¸‹ï¼š

```c
T3-ï¼to_parent=T1;
```

è€ƒè™‘è¿™æ ·ä¸€ä¸ªæƒ…æ™¯ï¼šå¦‚æœçº¿ç¨‹ C åœ¨å‘èµ·äº‹åŠ¡ T3 ç»™çº¿ç¨‹ A æ‰€å±çš„è¿›ç¨‹æ¥å¤„ç†æ—¶ï¼ŒBinder é©±åŠ¨ç¨‹åºé€‰æ‹©äº†è¯¥è¿›ç¨‹çš„å¦å¤–ä¸€ä¸ªçº¿ç¨‹ D æ¥å¤„ç†è¯¥äº‹åŠ¡ï¼Œè¿™æ—¶å€™ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢? è¿™æ—¶å€™çº¿ç¨‹ A å°±ä¼šå¤„äºç©ºé—²ç­‰å¾…çŠ¶æ€ï¼Œä»€ä¹ˆä¹Ÿä¸èƒ½åšï¼Œå› ä¸ºå®ƒå¿…é¡»è¦ç­‰çº¿ç¨‹ D å¤„ç†å®Œæˆäº‹åŠ¡ T3 åï¼Œå®ƒæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œäº‹åŠ¡ T1ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸å…¶è®©çº¿ç¨‹ A é—²ç€ï¼Œè¿˜ä¸å¦‚æŠŠäº‹åŠ¡ T3 äº¤ç»™å®ƒæ¥å¤„ç†ï¼Œè¿™æ ·çº¿ç¨‹ D å°±å¯ä»¥å»å¤„ç†å…¶ä»–äº‹åŠ¡ï¼Œæé«˜äº†è¿›ç¨‹çš„å¹¶å‘æ€§ã€‚

ç°åœ¨ï¼Œå…³é”®çš„é—®é¢˜åˆæ¥äº†â€”â€”Binderé©±åŠ¨ç¨‹åºåœ¨åˆ†å‘äº‹åŠ¡T3ç»™ç›®æ ‡è¿›ç¨‹å¤„ç†æ—¶ï¼Œå®ƒæ˜¯å¦‚ä½•çŸ¥é“çº¿ç¨‹Aå±äºç›®æ ‡è¿›ç¨‹ï¼Œå¹¶ä¸”æ­£åœ¨ç­‰å¾…äº‹åŠ¡T3çš„å¤„ç†ç»“æœçš„?å½“çº¿ç¨‹Cåœ¨å¤„ç†äº‹åŠ¡T2æ—¶ï¼Œå°±ä¼šå°†äº‹åŠ¡T2æ”¾åœ¨å…¶äº‹åŠ¡å †æ ˆtransaction_stackçš„æœ€å‰ç«¯ã€‚è¿™æ ·å½“çº¿ç¨‹Cå‘èµ·äº‹åŠ¡T3ç»™çº¿ç¨‹Aæ‰€å±çš„è¿›ç¨‹å¤„ç†æ—¶ï¼ŒBinderé©±åŠ¨ç¨‹åºå°±å¯ä»¥æ²¿ç€çº¿ç¨‹Cçš„äº‹åŠ¡å †æ ˆtransaction_stackå‘ä¸‹éå†ï¼Œå³æ²¿ç€äº‹åŠ¡T2çš„æˆå‘˜å˜é‡from_parentå‘ä¸‹éå†ï¼Œæœ€åå°±ä¼šå‘ç°äº‹åŠ¡T3çš„ç›®æ ‡è¿›ç¨‹ç­‰äºäº‹åŠ¡T1çš„æºè¿›ç¨‹ï¼Œå¹¶ä¸”äº‹åŠ¡T1æ˜¯ç”±çº¿ç¨‹Aå‘èµ·çš„ï¼Œè¿™æ—¶å€™å®ƒå°±çŸ¥é“çº¿ç¨‹Aæ­£åœ¨ç­‰å¾…äº‹åŠ¡T3çš„å¤„ç†ç»“æœäº†ã€‚

çº¿ç¨‹Aåœ¨å¤„ç†äº‹åŠ¡T3æ—¶ï¼ŒBinderé©±åŠ¨ç¨‹åºä¼šå°†äº‹åŠ¡T3æ”¾åœ¨å…¶äº‹åŠ¡å †æ ˆtransaction_stackçš„æœ€å‰ç«¯ï¼Œè€Œåœ¨æ­¤ä¹‹å‰ï¼Œè¯¥äº‹åŠ¡å †æ ˆtransaction_stackçš„æœ€å‰ç«¯æŒ‡å‘çš„æ˜¯äº‹åŠ¡T1ã€‚ä¸ºäº†èƒ½å¤Ÿè®©çº¿ç¨‹Aå¤„ç†å®Œæˆäº‹åŠ¡T3ä¹‹åï¼Œæ¥ç€å¤„ç†äº‹åŠ¡T1ï¼ŒBinderé©±åŠ¨ç¨‹åºä¼šå°†äº‹åŠ¡T1ä¿å­˜åœ¨äº‹åŠ¡T3çš„æˆå‘˜å˜é‡to_parentä¸­ã€‚ç­‰åˆ°çº¿ç¨‹Aå¤„ç†å®Œæˆäº‹åŠ¡T3ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡äº‹åŠ¡T3çš„æˆå‘˜å˜é‡to_parentæ‰¾åˆ°äº‹åŠ¡T1ï¼Œå†å°†å®ƒæ”¾åœ¨çº¿ç¨‹Açš„äº‹åŠ¡å †æ ˆtransaction_stackçš„æœ€å‰ç«¯äº†ã€‚


### ioctl é€šä¿¡æ•°æ®æ ¼å¼

#### binder_write_read

å…¶ä¸­ write_sizeã€write_consumedã€write_buffer ç”¨æ¥æè¿°ä»ç”¨æˆ·ç©ºé—´ä¼ è¾“åˆ° Binder é©±åŠ¨çš„æ•°æ®ã€‚

å¯¹åº”çš„ read_xxx æ¥æè¿°è¾“å‡ºæ•°æ®ï¼Œå³ä» binder é©±åŠ¨ç¨‹åºè¿”å›ç»™ç”¨æˆ·ç©ºé—´çš„æ•°æ®ã€‚

```c
struct binder_write_read {
    signed long	write_size;	/* bytes to write */
    signed long	write_consumed;	/* bytes consumed by driver */
    unsigned long	write_buffer;
    signed long	read_size;	/* bytes to read */
    signed long	read_consumed;	/* bytes consumed by driver */
    unsigned long	read_buffer;
};
```

<img src="android/framework/binder/data_struct/resources/3.png" style="width:100%">

ä¸€ä¸ª buffer çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤º, æ¯ä¸ª buffer éƒ½æ˜¯ç±»ä¼¼äºæ•°ç»„ä¸€æ ·çš„ä¸€ä¸ªæŒ¨ç€ä¸€ä¸ªçš„ç»“æ„ï¼Œæ¯ä¸€ä¸ªå…ƒç´ ç”±ä¸€ä¸ªé€šä¿¡åè®®ä»£ç å’Œé€šä¿¡æ•°æ®ç»„æˆã€‚

å…¶ä¸­ä¸€ç§æ˜¯åœ¨è¾“å…¥ç¼“å†²åŒº write_buffer ä¸­ä½¿ç”¨çš„ï¼Œç§°ä¸ºå‘½ä»¤åè®®ä»£ç ï¼Œå¦ä¸€ç§æ˜¯åœ¨è¾“å‡ºç¼“å†²åŒº read_buffer ä¸­ä½¿ç”¨çš„ï¼Œç§°ä¸ºè¿”å›åè®®ä»£ç ã€‚å‘½ä»¤åè®®ä»£ç é€šè¿‡ BinderDriverCommandProtocol æšä¸¾å€¼æ¥å®šä¹‰ï¼Œè€Œè¿”å›åè®®ä»£ç é€šè¿‡ BinderDriverReturnProtocol æšä¸¾å€¼æ¥å®šä¹‰ã€‚

#### å‘½ä»¤åè®®ç 

```c
enum BinderDriverCommandProtocol {
    // ä¸€ä¸ªè¿›ç¨‹å‘èµ· binder è¯·æ±‚ï¼Œæ•°æ®æ”¾åœ¨ binder_transaction_data ä¸­ã€‚
    BC_TRANSACTION = _IOW('c', 0, struct binder_transaction_data),
    // å½“è¿›ç¨‹å®Œæˆ binder è¯·æ±‚åï¼Œæ•°æ®æ”¾åœ¨ binder_transaction_data ä¸­è¿”å›ç»™æºè¿›ç¨‹ã€‚
    BC_REPLY = _IOW('c', 1, struct binder_transaction_data),
    /*
     * binder_transaction_data: the sent command.
     */

    /*
        å‘½ä»¤åè®®ä»£ç BC_FREE_BUFFERåé¢è·Ÿçš„é€šä¿¡æ•°æ®æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå®ƒæŒ‡å‘äº†åœ¨Binderé©±åŠ¨ç¨‹åºå†…éƒ¨æ‰€åˆ†é…çš„ä¸€å—å†…æ ¸ç¼“å†²åŒºã€‚
        Binderé©±åŠ¨ç¨‹åºå°±æ˜¯é€šè¿‡è¿™ä¸ªå†…æ ¸ç¼“å†²åŒºå°†æºè¿›ç¨‹çš„é€šä¿¡æ•°æ®ä¼ é€’åˆ°ç›®æ ‡è¿›ç¨‹çš„ã€‚å½“ç›®æ ‡è¿›ç¨‹å¤„ç†å®Œæˆæºè¿›ç¨‹çš„é€šä¿¡è¯·æ±‚ä¹‹åï¼Œ
        å®ƒå°±ä¼šä½¿ç”¨å‘½ä»¤åè®®ä»£ç BC_FREE_BUFFERæ¥é€šçŸ¥Binderé©±åŠ¨ç¨‹åºé‡Šæ”¾è¿™ä¸ªå†…æ ¸ç¼“å†²åŒºã€‚
    */
    BC_FREE_BUFFER = _IOW('c', 3, int),
    /*
     * void *: ptr to transaction data received on a read
     */

    /*
        å‘½ä»¤åè®®ä»£ç BC_INCREFSã€BC_ACQUIREã€BC_RELEASEå’ŒBC_DECREFSåé¢è·Ÿçš„é€šä¿¡æ•°æ®æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œ
        å®ƒæè¿°äº†ä¸€ä¸ªBinderå¼•ç”¨å¯¹è±¡çš„å¥æŸ„å€¼ï¼Œå…¶ä¸­ï¼Œå‘½ä»¤åè®®ä»£ç BC_INCREFSå’ŒBC_DECREFSåˆ†åˆ«ç”¨æ¥å¢åŠ å’Œå‡å°‘ä¸€ä¸ªBinderå¼•ç”¨å¯¹è±¡çš„å¼±å¼•ç”¨è®¡æ•°ï¼›
        è€Œå‘½ä»¤åè®®ä»£ç BC_ACQUIREå’ŒBC_RELEASEåˆ†åˆ«ç”¨æ¥å¢åŠ å’Œå‡å°‘ä¸€ä¸ªBinderå¼•ç”¨å¯¹è±¡çš„å¼ºå¼•ç”¨è®¡æ•°ã€‚
    */

    BC_INCREFS = _IOW('c', 4, int),
    BC_ACQUIRE = _IOW('c', 5, int),
    BC_RELEASE = _IOW('c', 6, int),
    BC_DECREFS = _IOW('c', 7, int),
    /*
     * int:	descriptor
     */

    /*
        å‘½ä»¤åè®®ä»£ç BC_INCREFS_DONEå’ŒBC_ACQUIRE_DONEåé¢è·Ÿçš„é€šä¿¡æ•°æ®ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“binder_ptr_cookieæ¥æè¿°ã€‚
        Binderé©±åŠ¨ç¨‹åºç¬¬ä¸€æ¬¡å¢åŠ ä¸€ä¸ªBinderå®ä½“å¯¹è±¡çš„å¼ºå¼•ç”¨è®¡æ•°æˆ–è€…å¼±å¼•ç”¨è®¡æ•°æ—¶ï¼Œ
        å°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_ACQUIREæˆ–è€…BR_INCREFSæ¥è¯·æ±‚å¯¹åº”çš„Serverè¿›ç¨‹å¢åŠ å¯¹åº”çš„Serviceç»„ä»¶çš„å¼ºå¼•ç”¨è®¡æ•°æˆ–è€…å¼±å¼•ç”¨è®¡æ•°ã€‚
        å½“Serverè¿›ç¨‹å¤„ç†å®Œæˆè¿™ä¸¤ä¸ªè¯·æ±‚ä¹‹åï¼Œå°±ä¼šåˆ†åˆ«ä½¿ç”¨å‘½ä»¤åè®®ä»£ç BC_INCREFS_DONEå’ŒBC_ACQUIRE_DONEå°†æ“ä½œç»“æœè¿”å›ç»™Binderé©±åŠ¨ç¨‹åºã€‚
    */

    BC_INCREFS_DONE = _IOW('c', 8, struct binder_ptr_cookie),
    BC_ACQUIRE_DONE = _IOW('c', 9, struct binder_ptr_cookie),
    /*
     * void *: ptr to binder
     * void *: cookie for binder
     */

    /*
        å‘½ä»¤åè®®ä»£ç BC_REGISTER_LOOPERã€BC_ENTER_LOOPERå’ŒBC_EXIT_LOOPERåé¢ä¸éœ€è¦æŒ‡å®šé€šä¿¡æ•°æ®ã€‚
        
        ä¸€æ–¹é¢ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å°†è‡ªå·±æ³¨å†Œåˆ°Binderé©±åŠ¨ç¨‹åºä¹‹åï¼Œå®ƒæ¥ç€å°±ä¼šä½¿ç”¨å‘½ä»¤åè®®ä»£ç BC_ENTER_LOOPERæ¥é€šçŸ¥Binderé©±åŠ¨ç¨‹åºï¼Œå®ƒå·²ç»å‡†å¤‡å°±ç»ªå¤„ç†è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚äº†ï¼›
        
        å¦ä¸€æ–¹é¢ï¼Œå½“Binderé©±åŠ¨ç¨‹åºä¸»åŠ¨è¯·æ±‚è¿›ç¨‹æ³¨å†Œä¸€ä¸ªæ–°çš„çº¿ç¨‹åˆ°å®ƒçš„Binderçº¿ç¨‹æ± ä¸­æ¥å¤„ç†è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚ä¹‹åï¼Œæ–°åˆ›å»ºçš„çº¿ç¨‹å°±ä¼šä½¿ç”¨å‘½ä»¤åè®®ä»£ç BC_REGISTER_LOOPERæ¥é€šçŸ¥Binderé©±åŠ¨ç¨‹åºï¼Œå®ƒå‡†å¤‡å°±ç»ªäº†ã€‚
        
        æœ€åï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¦é€€å‡ºæ—¶ï¼Œå®ƒå°±ä½¿ç”¨å‘½ä»¤åè®®ä»£ç BC_EXIT_LOOPERä»Binderé©±åŠ¨ç¨‹åºä¸­æ³¨é”€ï¼Œè¿™æ ·å®ƒå°±ä¸ä¼šå†æ¥æ”¶åˆ°è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚äº†ã€‚
    */

    BC_REGISTER_LOOPER = _IO('c', 11),
    /*
     * No parameters.
     * Register a spawned looper thread with the device.
     */

    BC_ENTER_LOOPER = _IO('c', 12),
    BC_EXIT_LOOPER = _IO('c', 13),
    /*
     * No parameters.
     * These two commands are sent as an application-level thread
     * enters and exits the binder loop, respectively.  They are
     * used so the binder can have an accurate count of the number
     * of looping threads it has available.
     */

    /*
        å‘½ä»¤åè®®ä»£ç BC_REQUEST_DEATH_NOTIFICATIONå’ŒBC_CLEAR_DEATH_NOTIFICATIONåé¢è·Ÿçš„é€šä¿¡æ•°æ®ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“binder_ptr_cookieæ¥æè¿°ã€‚
        
        ä¸€æ–¹é¢ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹å¸Œæœ›è·å¾—å®ƒæ‰€å¼•ç”¨çš„Serviceç»„ä»¶çš„æ­»äº¡æ¥æ”¶é€šçŸ¥ï¼Œé‚£ä¹ˆå®ƒå°±éœ€è¦ä½¿ç”¨å‘½ä»¤åè®®ä»£ç BC_REQUEST_DEATH_NOTIFICATIONæ¥å‘Binderé©±åŠ¨ç¨‹åºæ³¨å†Œä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥ï¼›
        
        å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹æƒ³æ³¨é”€ä¹‹å‰æ‰€æ³¨å†Œçš„ä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥ï¼Œé‚£ä¹ˆå®ƒå°±éœ€è¦ä½¿ç”¨å‘½ä»¤åè®®ä»£ç BC_CLEAR_DEATH_NOTIFICATIONæ¥å‘Binderé©±åŠ¨ç¨‹åºå‘å‡ºè¯·æ±‚ã€‚
    */

    BC_REQUEST_DEATH_NOTIFICATION = _IOW('c', 14, struct binder_ptr_cookie),
    /*
     * void *: ptr to binder
     * void *: cookie
     */

    BC_CLEAR_DEATH_NOTIFICATION = _IOW('c', 15, struct binder_ptr_cookie),
    /*
     * void *: ptr to binder
     * void *: cookie
     */

    /*
        å‘½ä»¤åè®®ä»£ç BC_DEAD_BINDER_DONEåé¢è·Ÿçš„é€šä¿¡æ•°æ®æ˜¯ä¸€ä¸ªvoidç±»å‹çš„æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥ç»“æ„ä½“binder_ref_deathçš„åœ°å€ã€‚
        
        å½“ä¸€ä¸ªè¿›ç¨‹è·å¾—ä¸€ä¸ªServiceç»„ä»¶çš„æ­»äº¡é€šçŸ¥æ—¶ï¼Œå®ƒå°±ä¼šä½¿ç”¨å‘½ä»¤åè®®ä»£ç BC_DEAD_BINDER_DONEæ¥é€šçŸ¥Binderé©±åŠ¨ç¨‹åºï¼Œå®ƒå·²ç»å¤„ç†å®Œæˆè¯¥Serviceç»„ä»¶çš„æ­»äº¡é€šçŸ¥äº†ã€‚
    */

    BC_DEAD_BINDER_DONE = _IOW('c', 16, void *),
    /*
     * void *: cookie
     */
};
```

#### è¿”å›åè®®ç 

```c
enum BinderDriverReturnProtocol {
    // Binderé©±åŠ¨ç¨‹åºåœ¨å¤„ç†åº”ç”¨ç¨‹åºè¿›ç¨‹å‘å‡ºçš„æŸä¸ªè¯·æ±‚æ—¶ï¼Œå¦‚æœå‘ç”Ÿäº†å¼‚å¸¸æƒ…å†µï¼Œå®ƒå°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_ERRORæ¥é€šçŸ¥åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚
    BR_ERROR = _IOR('r', 0, int),
    /*
     * int: error code
     */
    // è¿”å›åè®®ä»£ç BR_OKåé¢ä¸éœ€è¦æŒ‡å®šé€šä¿¡æ•°æ®ã€‚Binderé©±åŠ¨ç¨‹åºæˆåŠŸå¤„ç†äº†åº”ç”¨ç¨‹åºè¿›ç¨‹å‘å‡ºçš„æŸä¸€ä¸ªè¯·æ±‚ä¹‹åï¼Œå®ƒå°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_OKæ¥é€šçŸ¥åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚
    BR_OK = _IO('r', 1),
    /* No parameters! */

    /*
        è¿”å›åè®®ä»£ç BR_TRANSACTIONå’ŒBR_REPLYåé¢è·Ÿçš„é€šä¿¡æ•°æ®ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“binder_transaction_dataæ¥æè¿°ã€‚
        
        å½“ä¸€ä¸ªClientè¿›ç¨‹å‘ä¸€ä¸ªServerè¿›ç¨‹å‘å‡ºè¿›ç¨‹é—´é€šä¿¡è¯·æ±‚æ—¶ï¼ŒBinderé©±åŠ¨ç¨‹åºå°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_TRANSACTIONé€šçŸ¥è¯¥Serverè¿›ç¨‹æ¥å¤„ç†è¯¥è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚ï¼›
        å½“Serverè¿›ç¨‹å¤„ç†å®Œæˆè¯¥è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚ä¹‹åï¼ŒBinderé©±åŠ¨ç¨‹åºå°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_REPLYå°†è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚ç»“æœæ•°æ®è¿”å›ç»™Clientè¿›ç¨‹ã€‚
    */

    BR_TRANSACTION = _IOR('r', 2, struct binder_transaction_data),
    BR_REPLY = _IOR('r', 3, struct binder_transaction_data),
    /*
     * binder_transaction_data: the received command.
     */

    /*
        è¿”å›åè®®ä»£ç BR_DEAD_REPLYåé¢ä¸éœ€è¦æŒ‡å®šé€šä¿¡æ•°æ®ã€‚Binderé©±åŠ¨ç¨‹åºåœ¨å¤„ç†è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚æ—¶ï¼Œå¦‚æœå‘ç°ç›®æ ‡è¿›ç¨‹æˆ–è€…ç›®æ ‡çº¿ç¨‹å·²ç»æ­»äº¡ï¼Œ
        å®ƒå°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_DEAD_REPLYæ¥é€šçŸ¥æºè¿›ç¨‹ã€‚
    */
    BR_DEAD_REPLY = _IO('r', 5),
    /*
     * The target of the last transaction (either a bcTRANSACTION or
     * a bcATTEMPT_ACQUIRE) is no longer with us.  No parameters.
     */

    /*
        è¿”å›åè®®ä»£ç BR_TRANSACTION_COMPLETEåé¢ä¸éœ€è¦æŒ‡å®šé€šä¿¡æ•°æ®ã€‚å½“Binderé©±åŠ¨ç¨‹åºæ¥æ”¶åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ç»™å®ƒå‘é€çš„ä¸€ä¸ªå‘½ä»¤åè®®ä»£ç BC_TRANSACTIONæˆ–è€…BC_REPLYæ—¶ï¼Œ
        å®ƒå°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_TRANSACTION_COMPLETEæ¥é€šçŸ¥åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œè¯¥å‘½ä»¤åè®®ä»£ç å·²ç»è¢«æ¥æ”¶ï¼Œæ­£åœ¨åˆ†å‘ç»™ç›®æ ‡è¿›ç¨‹æˆ–è€…ç›®æ ‡çº¿ç¨‹å¤„ç†ã€‚
    */

    BR_TRANSACTION_COMPLETE = _IO('r', 6),
    /*
     * No parameters... always refers to the last transaction requested
     * (including replies).  Note that this will be sent even for
     * asynchronous transactions.
     */

    /*
        è¿”å›åè®®ä»£ç BR_INCREFSã€BR_ACQUIREã€BR_RELEASEå’ŒBR_DECREFSåé¢è·Ÿçš„é€šä¿¡æ•°æ®ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“binder_ptr_cookieæ¥æè¿°ï¼Œ
        å…¶ä¸­ï¼Œè¿”å›åè®®ä»£ç BR_INCREFSå’ŒBR_DECREFSåˆ†åˆ«ç”¨æ¥å¢åŠ å’Œå‡å°‘ä¸€ä¸ªServiceç»„ä»¶çš„å¼±å¼•ç”¨è®¡æ•°ï¼›
        è€Œè¿”å›åè®®ä»£ç BR_ACQUIREå’ŒBR_RELEASEåˆ†åˆ«ç”¨æ¥å¢åŠ å’Œå‡å°‘ä¸€ä¸ªServiceç»„ä»¶çš„å¼ºå¼•ç”¨è®¡æ•°ã€‚
    */
    BR_INCREFS = _IOR('r', 7, struct binder_ptr_cookie),
    BR_ACQUIRE = _IOR('r', 8, struct binder_ptr_cookie),
    BR_RELEASE = _IOR('r', 9, struct binder_ptr_cookie),
    BR_DECREFS = _IOR('r', 10, struct binder_ptr_cookie),
    /*
     * void *:	ptr to binder
     * void *: cookie for binder
     */

    BR_NOOP = _IO('r', 12),
    /*
     * No parameters.  Do nothing and examine the next command.  It exists
     * primarily so that we can replace it with a BR_SPAWN_LOOPER command.
     */

    /*
        è¿”å›åè®®ä»£ç BR_SPAWN_LOOPERåé¢ä¸éœ€è¦æŒ‡å®šé€šä¿¡æ•°æ®ã€‚å½“Binderé©±åŠ¨ç¨‹åºå‘ç°ä¸€ä¸ªè¿›ç¨‹æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—²Binderçº¿ç¨‹æ¥å¤„ç†è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚æ—¶ï¼Œ
        å®ƒå°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_SPAWN_LOOPERæ¥é€šçŸ¥è¯¥è¿›ç¨‹å¢åŠ ä¸€ä¸ªæ–°çš„çº¿ç¨‹åˆ°Binderçº¿ç¨‹æ± ä¸­ã€‚
    */

    BR_SPAWN_LOOPER = _IO('r', 13),
    /*
     * No parameters.  The driver has determined that a process has no
     * threads waiting to service incomming transactions.  When a process
     * receives this command, it must spawn a new service thread and
     * register it via bcENTER_LOOPER.
     */

    /*
        è¿”å›åè®®ä»£ç BR_DEAD_BINDERå’ŒBR_CLEAR_DEATH_NOTIFICATION_DONEåé¢è·Ÿçš„é€šä¿¡æ•°æ®æ˜¯ä¸€ä¸ªvoidç±»å‹çš„æŒ‡é’ˆï¼Œ
        å®ƒæŒ‡å‘ä¸€ä¸ªç”¨æ¥æ¥æ”¶Serviceç»„ä»¶æ­»äº¡é€šçŸ¥çš„å¯¹è±¡çš„åœ°å€ã€‚å½“Binderé©±åŠ¨ç¨‹åºç›‘æµ‹åˆ°ä¸€ä¸ªServiceç»„ä»¶çš„æ­»äº¡äº‹ä»¶æ—¶ï¼Œ
        å®ƒå°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_DEAD_BINDERæ¥é€šçŸ¥ç›¸åº”çš„Clientè¿›ç¨‹ã€‚å½“Clientè¿›ç¨‹é€šçŸ¥Binderé©±åŠ¨ç¨‹åºæ³¨é”€å®ƒä¹‹å‰æ‰€æ³¨å†Œçš„ä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥æ—¶ï¼Œ
        Binderé©±åŠ¨ç¨‹åºæ‰§è¡Œå®Œæˆè¿™ä¸ªæ³¨é”€æ“ä½œä¹‹åï¼Œå°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_CLEAR_DEATH_NOTIFICATION_DONEæ¥é€šçŸ¥Clientè¿›ç¨‹ã€‚
    */
    BR_DEAD_BINDER = _IOR('r', 15, void *),
    /*
     * void *: cookie
     */
    BR_CLEAR_DEATH_NOTIFICATION_DONE = _IOR('r', 16, void *),
    /*
     * void *: cookie
     */

    /*
        è¿”å›åè®®ä»£ç BR_FAILED_REPLYåé¢ä¸éœ€è¦æŒ‡å®šé€šä¿¡æ•°æ®ã€‚å½“Binderé©±åŠ¨ç¨‹åºå¤„ç†ä¸€ä¸ªè¿›ç¨‹å‘å‡ºçš„BC_TRANSACTIONå‘½ä»¤åè®®æ—¶ï¼Œ
        å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸æƒ…å†µï¼Œå®ƒå°±ä¼šä½¿ç”¨è¿”å›åè®®ä»£ç BR_FAILED_REPLYæ¥é€šçŸ¥æºè¿›ç¨‹
    */
    BR_FAILED_REPLY = _IO('r', 17),
    /*
     * The the last transaction (either a bcTRANSACTION or
     * a bcATTEMPT_ACQUIRE) failed (e.g. out of memory).  No parameters.
     */
};
```

#### binder_ptr_cookie

```c
struct binder_ptr_cookie {
    void *ptr;
    void *cookie;
};
```

ç»“æ„ä½“binder_ptr_cookieç”¨æ¥æè¿°ä¸€ä¸ªBinderå®ä½“å¯¹è±¡æˆ–è€…ä¸€ä¸ªServiceç»„ä»¶çš„æ­»äº¡æ¥æ”¶é€šçŸ¥ã€‚

å½“ç»“æ„ä½“binder_ptr_cookieæè¿°çš„æ˜¯ä¸€ä¸ªBinderå®ä½“å¯¹è±¡æ—¶ï¼Œæˆå‘˜å˜é‡ptrå’Œcookieçš„å«ä¹‰ç­‰åŒäºå‰é¢æ‰€ä»‹ç»çš„ç»“æ„ä½“binder_nodeçš„æˆå‘˜å˜é‡ptrå’Œcookieï¼›

å½“ç»“æ„ä½“binder_ptr_cookieæè¿°çš„æ˜¯ä¸€ä¸ªServiceç»„ä»¶çš„æ­»äº¡æ¥æ”¶é€šçŸ¥æ—¶ï¼Œæˆå‘˜å˜é‡ptræŒ‡å‘çš„æ˜¯ä¸€ä¸ªBinderå¼•ç”¨å¯¹è±¡çš„å¥æŸ„å€¼ï¼Œè€Œæˆå‘˜å˜é‡cookieæŒ‡å‘çš„æ˜¯ä¸€ä¸ªç”¨æ¥æ¥æ”¶æ­»äº¡é€šçŸ¥çš„å¯¹è±¡çš„åœ°å€ binder_ref_deathã€‚


#### binder_transaction_data

ç»“æ„ä½“binder_transaction_dataç”¨æ¥æè¿°è¿›ç¨‹é—´é€šä¿¡è¿‡ç¨‹ä¸­æ‰€ä¼ è¾“çš„æ•°æ®ã€‚

æˆå‘˜å˜é‡targetæ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œç”¨æ¥æè¿°ä¸€ä¸ªç›®æ ‡Binderå®ä½“å¯¹è±¡æˆ–è€…ç›®æ ‡Binderå¼•ç”¨å¯¹è±¡ã€‚å¦‚æœå®ƒæè¿°çš„æ˜¯ä¸€ä¸ªç›®æ ‡Binderå®ä½“å¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒçš„æˆå‘˜å˜é‡ptrå°±æŒ‡å‘ä¸è¯¥Binderå®ä½“å¯¹è±¡å¯¹åº”çš„ä¸€ä¸ªServiceç»„ä»¶å†…éƒ¨çš„ä¸€ä¸ªå¼±å¼•ç”¨è®¡æ•°å¯¹è±¡(weakref_impl)çš„åœ°å€ï¼›å¦‚æœå®ƒæè¿°çš„æ˜¯ä¸€ä¸ªç›®æ ‡Binderå¼•ç”¨å¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒçš„æˆå‘˜å˜é‡handleå°±æŒ‡å‘è¯¥Binderå¼•ç”¨å¯¹è±¡çš„å¥æŸ„å€¼ã€‚

æˆå‘˜å˜é‡cookieæ˜¯ç”±åº”ç”¨ç¨‹åºè¿›ç¨‹æŒ‡å®šçš„é¢å¤–å‚æ•°ã€‚å½“Binderé©±åŠ¨ç¨‹åºä½¿ç”¨è¿”å›å‘½ä»¤åè®®BR_TRANSACTIONå‘ä¸€ä¸ªServerè¿›ç¨‹å‘å‡ºä¸€ä¸ªè¿›ç¨‹é—´é€šä¿¡è¯·æ±‚æ—¶ï¼Œè¿™ä¸ªæˆå‘˜å˜é‡æ‰æœ‰å®é™…æ„ä¹‰ï¼Œå®ƒæŒ‡å‘çš„æ˜¯ç›®æ ‡Serviceç»„ä»¶çš„åœ°å€ã€‚

æˆå‘˜å˜é‡codeæ˜¯ç”±æ‰§è¡Œè¿›ç¨‹é—´é€šä¿¡çš„ä¸¤ä¸ªè¿›ç¨‹äº’ç›¸çº¦å®šå¥½çš„ä¸€ä¸ªé€šä¿¡ä»£ç ï¼ŒBinderé©±åŠ¨ç¨‹åºå®Œå…¨ä¸å…³å¿ƒå®ƒçš„å«ä¹‰

```c
struct binder_transaction_data {
    /* The first two are only used for bcTRANSACTION and brTRANSACTION,
     * identifying the target and contents of the transaction.
     */
    union {
        size_t	handle;	/* target descriptor of command transaction */
        void	*ptr;	/* target descriptor of return transaction */
    } target;
    void		*cookie;	/* target object cookie */
    unsigned int	code;		/* transaction command */

    /* General information about the transaction. */
    unsigned int	flags;
    pid_t		sender_pid;
    uid_t		sender_euid;
    size_t		data_size;	/* number of bytes of data */
    size_t		offsets_size;	/* number of bytes of offsets */

    /* If this transaction is inline, the data immediately
     * follows here; otherwise, it ends with a pointer to
     * the data buffer.
     */
    union {
        struct {
            /* transaction data */
            const void	*buffer;
            /* offsets from buffer to flat_binder_object structs */
            const void	*offsets;
        } ptr;
        uint8_t	buf[8];
    } data;
};
```

æˆå‘˜å˜é‡flagsæ˜¯ä¸€ä¸ªæ ‡å¿—å€¼ï¼Œç”¨æ¥æè¿°è¿›ç¨‹é—´é€šä¿¡è¡Œä¸ºç‰¹å¾ï¼Œå®ƒçš„å–å€¼å¦‚ä¸‹æ‰€ç¤ºã€‚
- å¦‚æœæˆå‘˜å˜é‡flagsçš„TF_ONE_WAYä½è¢«è®¾ç½®ä¸º1ï¼Œå°±è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿›ç¨‹é—´é€šä¿¡è¿‡ç¨‹ï¼›
- å¦‚æœæˆå‘˜å˜é‡flagsçš„TF_ACCEPT_FDSä½è¢«è®¾ç½®ä¸º0ï¼Œå°±è¡¨ç¤ºæºè¿›ç¨‹ä¸å…è®¸ç›®æ ‡è¿›ç¨‹è¿”å›çš„ç»“æœæ•°æ®ä¸­åŒ…å«æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼›
- å¦‚æœæˆå‘˜å˜é‡flagsçš„TF_STATUS_CODEä½è¢«è®¾ç½®ä¸º1ï¼Œå°±è¡¨ç¤ºæˆå‘˜å˜é‡dataæ‰€æè¿°çš„æ•°æ®ç¼“å†²åŒºçš„å†…å®¹æ˜¯ä¸€ä¸ª4å­—èŠ‚çš„çŠ¶æ€ç ã€‚

```c
enum transaction_flags {
    TF_ONE_WAY	= 0x01,	/* this is a one-way call: async, no return */
    TF_ROOT_OBJECT	= 0x04,	/* contents are the component's root object */
    TF_STATUS_CODE	= 0x08,	/* contents are a 32-bit status code */
    TF_ACCEPT_FDS	= 0x10,	/* allow replies with file descriptors */
};
```

æˆå‘˜å˜é‡sender_pidå’Œsender_euidè¡¨ç¤ºå‘èµ·è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚çš„è¿›ç¨‹çš„PIDå’ŒUIDã€‚è¿™ä¸¤ä¸ªæˆå‘˜å˜é‡çš„å€¼æ˜¯ç”±Binderé©±åŠ¨ç¨‹åºæ¥å¡«å†™çš„ï¼Œå› æ­¤ï¼Œç›®æ ‡è¿›ç¨‹é€šè¿‡è¿™ä¸¤ä¸ªæˆå‘˜å˜é‡å°±å¯ä»¥è¯†åˆ«å‡ºæºè¿›ç¨‹çš„èº«ä»½ï¼Œä»¥ä¾¿è¿›è¡Œå®‰å…¨æ£€æŸ¥ã€‚

æˆå‘˜å˜é‡data_sizeå’Œoffsets_sizeåˆ†åˆ«ç”¨æ¥æè¿°ä¸€ä¸ªé€šä¿¡æ•°æ®ç¼“å†²åŒºä»¥åŠä¸€ä¸ªåç§»æ•°ç»„çš„å¤§å°ã€‚offsets_size çš„å€¼å°±æ˜¯ data.ptr->offsets è¿™ä¸ªæ•°ç»„çš„å¤§å°ã€‚

æˆå‘˜å˜é‡dataæ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªé€šä¿¡æ•°æ®ç¼“å†²åŒºã€‚å½“é€šä¿¡æ•°æ®è¾ƒå°æ—¶ï¼Œå°±ç›´æ¥ä½¿ç”¨è”åˆä½“å†…é™æ€åˆ†é…çš„æ•°ç»„bufæ¥ä¼ è¾“æ•°æ®ï¼›

å½“é€šä¿¡æ•°æ®è¾ƒå¤§æ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨ä¸€å—åŠ¨æ€åˆ†é…çš„ç¼“å†²åŒºæ¥ä¼ è¾“æ•°æ®äº†ã€‚è¿™å—åŠ¨æ€åˆ†é…çš„ç¼“å†²åŒºé€šè¿‡ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªæŒ‡é’ˆçš„ç»“æ„ä½“æ¥æè¿°ï¼Œå³é€šè¿‡è”åˆä½“å†…çš„æˆå‘˜å˜é‡ptræ¥æè¿°ã€‚ç»“æ„ä½“ptrçš„æˆå‘˜å˜é‡bufferæŒ‡å‘ä¸€ä¸ªæ•°æ®ç¼“å†²åŒºï¼Œå®ƒæ˜¯çœŸæ­£ç”¨æ¥ä¿å­˜é€šä¿¡æ•°æ®çš„ï¼Œå®ƒçš„å¤§å°ç”±å‰é¢æ‰€æè¿°çš„æˆå‘˜å˜é‡data_sizeæ¥æŒ‡å®šã€‚å½“æ•°æ®ç¼“å†²åŒºä¸­åŒ…å«æœ‰Binderå¯¹è±¡æ—¶ï¼Œé‚£ä¹ˆç´§è·Ÿåœ¨è¿™ä¸ªæ•°æ®ç¼“å†²åŒºçš„åé¢å°±ä¼šæœ‰ä¸€ä¸ªåç§»æ•°ç»„offsetsï¼Œç”¨æ¥æè¿°æ•°æ®ç¼“å†²åŒºä¸­æ¯ä¸€ä¸ªBinderå¯¹è±¡çš„ä½ç½®ã€‚æœ‰äº†è¿™ä¸ªåç§»æ•°ç»„ä¹‹åï¼ŒBinderé©±åŠ¨ç¨‹åºå°±å¯ä»¥æ­£ç¡®åœ°ç»´æŠ¤å…¶å†…éƒ¨çš„Binderå®ä½“å¯¹è±¡å’ŒBinderå¼•ç”¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°

<img src="android/framework/binder/data_struct/resources/4.png" style="width:100%">


#### flat_binder_object

data ä¸­æ¯ä¸€ä¸ª binder å¯¹è±¡ä½¿ç”¨ flat_binder_object ç»“æ„æ¥è¿›è¡Œæè¿°ã€‚

```c
struct flat_binder_object {
    /* 8 bytes for large_flat_header. */
    unsigned long		type;
    unsigned long		flags;
    /* 8 bytes of data. */
    union {
        void		*binder;	/* local object */
        signed long	handle;		/* remote object */
    };
    /* extra data associated with local object */
    void			*cookie;
};
```

å› ä¸º flat_binder_object ä¸æ­¢å¯ä»¥æè¿° binder å¯¹è±¡ï¼Œè¿˜å¯ä»¥æè¿°æ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥ä½¿ç”¨ type æ¥è¿›è¡ŒåŒºåˆ†ã€‚

- BINDER_TYPE_BINDER å’Œ BINDER_TYPE_WEAK_BINDER éƒ½æ˜¯ç”¨æ¥æè¿°ä¸€ä¸ª Binder å®ä½“å¯¹è±¡çš„ï¼Œå‰è€…æè¿°çš„æ˜¯ä¸€ä¸ªå¼ºç±»å‹çš„ Binder å®ä½“å¯¹è±¡ï¼Œè€Œåè€…æè¿°çš„æ˜¯ä¸€ä¸ªå¼±ç±»å‹çš„Binder å®ä½“å¯¹è±¡ã€‚
- BINDER_TYPE_HANDLE å’Œ BINDER_TYPE_WEAK_HANDLE æ¥æè¿°ä¸€ä¸ªBinderå¼•ç”¨å¯¹è±¡ï¼Œå‰è€…æè¿°çš„æ˜¯ä¸€ä¸ªå¼ºç±»å‹çš„Binderå¼•ç”¨å¯¹è±¡ï¼Œè€Œåè€…æè¿°çš„æ˜¯ä¸€ä¸ªå¼±ç±»å‹çš„Binderå¼•ç”¨å¯¹è±¡ã€‚
- BINDER_TYPE_FD æè¿°ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚

```c
#define B_PACK_CHARS(c1, c2, c3, c4) \
    ((((c1)<<24)) | (((c2)<<16)) | (((c3)<<8)) | (c4))
#define B_TYPE_LARGE 0x85
enum {
    BINDER_TYPE_BINDER	= B_PACK_CHARS('s', 'b', '*', B_TYPE_LARGE),
    BINDER_TYPE_WEAK_BINDER	= B_PACK_CHARS('w', 'b', '*', B_TYPE_LARGE),
    BINDER_TYPE_HANDLE	= B_PACK_CHARS('s', 'h', '*', B_TYPE_LARGE),
    BINDER_TYPE_WEAK_HANDLE	= B_PACK_CHARS('w', 'h', '*', B_TYPE_LARGE),
    BINDER_TYPE_FD		= B_PACK_CHARS('f', 'd', '*', B_TYPE_LARGE),
};
```

æˆå‘˜å˜é‡flagsæ˜¯ä¸€ä¸ªæ ‡å¿—å€¼ï¼Œåªæœ‰å½“ç»“æ„ä½“flat_binder_objectæè¿°çš„æ˜¯ä¸€ä¸ªBinderå®ä½“å¯¹è±¡æ—¶ï¼Œå®ƒæ‰æœ‰å®é™…æ„ä¹‰ã€‚ç›®å‰åªç”¨åˆ°è¯¥æˆå‘˜å˜é‡çš„ç¬¬0ä½åˆ°ç¬¬8ä½ã€‚å…¶ä¸­ï¼Œç¬¬0ä½åˆ°ç¬¬7ä½æè¿°çš„æ˜¯ä¸€ä¸ªBinderå®ä½“å¯¹è±¡åœ¨å¤„ç†ä¸€ä¸ªè¿›ç¨‹é—´é€šä¿¡è¯·æ±‚æ—¶ï¼Œå®ƒæ‰€è¿è¡Œåœ¨çš„çº¿ç¨‹åº”å½“å…·æœ‰çš„æœ€å°çº¿ç¨‹ä¼˜å…ˆçº§ï¼›ç¬¬8ä½ç”¨æ¥æè¿°ä¸€ä¸ªBinderå®ä½“å¯¹è±¡æ˜¯å¦å¯ä»¥å°†ä¸€å—åŒ…å«æœ‰æ–‡ä»¶æè¿°ç¬¦çš„æ•°æ®ç¼“å†²åŒºä¼ è¾“ç»™ç›®æ ‡è¿›ç¨‹ï¼Œå¦‚æœå®ƒçš„å€¼ç­‰äº1ï¼Œå°±è¡¨ç¤ºå…è®¸ï¼Œå¦åˆ™å°±ä¸å…è®¸ã€‚

æˆå‘˜å˜é‡binderå’Œhandleç»„æˆäº†ä¸€ä¸ªè”åˆä½“ã€‚å½“ç»“æ„ä½“flat_binder_objectæè¿°çš„æ˜¯ä¸€ä¸ªBinderå®ä½“å¯¹è±¡æ—¶ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨æˆå‘˜å˜é‡binderæ¥æŒ‡å‘ä¸è¯¥Binderå®ä½“å¯¹è±¡å¯¹åº”çš„ä¸€ä¸ªServiceç»„ä»¶å†…éƒ¨çš„ä¸€ä¸ªå¼±å¼•ç”¨è®¡æ•°å¯¹è±¡(weakref_impl)çš„åœ°å€ï¼Œå¹¶ä¸”ä½¿ç”¨æˆå‘˜å˜é‡cookieæ¥æŒ‡å‘è¯¥Serviceç»„ä»¶çš„åœ°å€ï¼›å½“ç»“æ„ä½“flat_binder_objectæè¿°çš„æ˜¯ä¸€ä¸ªBinderå¼•ç”¨å¯¹è±¡æ—¶ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨æˆå‘˜å˜é‡handleæ¥æè¿°è¯¥Binderå¼•ç”¨å¯¹è±¡çš„å¥æŸ„å€¼ã€‚ (è¿™é‡Œæˆ‘ç†è§£æœ‰å®ä½“å’Œå¼•ç”¨çš„åŒºåˆ«åœ¨äºï¼Œå‘èµ· binder è¯·æ±‚çš„è¿›ç¨‹å¦‚æœå’ŒæœåŠ¡ç«¯åŒä¸€ä¸ªè¿›ç¨‹ï¼Œå°±ä¼šè¿”å›å®ä½“ï¼Œå¦åˆ™è¿”å›çš„å¼•ç”¨)ã€‚


### ç»“æ„ä¹‹é—´çš„å…³ç³»

ä¸‹é¢å¤§è‡´çš„å±•ç¤ºäº†ä¸€ä¸ªå…³é”®æ•°æ®ç»“æ„ä¹‹é—´çš„ç±»å…³ç³»ã€‚

<img src="android/framework/binder/data_struct/resources/5.png" style="width:80%">