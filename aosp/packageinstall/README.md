# Android APK 安装流程

一个 App 从一个 `.apk` 文件变成你手机上可以点击运行的图标，这个过程其实相当复杂和精妙，涉及到安卓系统的多个层面，特别是安全和性能优化。

## 获取与安装

无论是从应用商店，还是自己获取 apk，安装的时候，首先会触发 package installer 应用。 一般放在 `/system/bin/pm` 目录下。

pm 通过与 PMS 进行通信来开始 apk 的真正安装流程。


## 解析与验证

### 解析 APK

- PMS 首先需要“解开”这个 APK 包，读取里面的核心信息，尤其是 `AndroidManifest.xml` 文件。这个文件就像是 App 的“身份证”和“说明书”，包含了：
  - 包名 (Package Name): App 的唯一标识，如 `com.google.android.youtube`。系统通过它来区分不同 App。
  - 版本号 (Version Code): 用于判断是新安装还是升级。
  - 所需权限 (Permissions): App 需要访问哪些系统功能，如相机、网络、联系人等。
  - 应用组件 (Components): 声明了所有的活动 (Activities)、服务 (Services)、广播接收器 (Broadcast Receivers) 等。
  - 最低 SDK 版本要求： 确定 App 能否在当前安卓系统版本上运行。


### 签名验证

- 这是整个流程中最关键的安全步骤！ 每个 APK 都必须被开发者用一个私钥进行数字签名。PMS 会用对应的公钥来验证这个签名。
- 目的有二：
  - 保证来源可靠性： 确认这个 App 确实是由声称的开发者发布的，而不是别人冒充的。
  - 保证文件完整性： 确认 APK 文件在传输过程中没有被篡改或损坏。任何一点改动都会导致签名失效。
- 对于升级： 如果你手机上已经安装了同一个包名的 App，PMS 会比较新旧两个 APK 的签名。签名必须完全一致，系统才允许升级。这就是为什么你无法用一个“破解版”（通常被重新签名）来覆盖官方原版应用的原因。如果签名不匹配，安装会直接失败。



## 准备环境

安检通过后，系统就要为这个新 App 准备一个“家”了。

1. 创建数据目录 (Data Directory):
  - 安卓系统会为每个 App 创建一个私有的数据目录，通常位于 `/data/data/<包名>`。
  - 这个目录是 App 的“沙盒” (Sandbox)。默认情况下，App 只能访问自己的数据目录，无法访问其他 App 的私有数据。这正是安卓系统安全模型的基础，保证了 App 之间的数据隔离。
  - 这个目录里会存放 App 的数据库、配置文件、缓存等所有私有数据。

2. 分配用户 ID (UID):
  - 在更底层的 Linux 内核层面，安卓会为每个安装的 App 分配一个独一无二的 Linux User ID (UID)。
  - 系统通过这个 UID 来管理 App 的文件权限和进程权限，进一步强化了沙盒机制。


## 复制与优化

万事俱备，现在开始真正的“安装”操作。
1. 复制 APK 文件:
系统会将原始的 APK 文件复制到一个受系统保护的目录，通常是 `/data/app/<包名>-<随机字符串>/base.apk`。这样做是为了保护 App 的核心文件不被用户或其他程序轻易修改或删除。
2. 代码优化 (AOT/JIT 编译):
APK 里的可执行代码是以 `classes.dex` (Dalvik Executable) 文件的形式存在的。这是一种为安卓虚拟机优化的字节码。为了让 App 运行得更快，现代安卓系统（使用 ART 运行时）会在安装时进行 Ahead-Of-Time (AOT) 编译。这个过程会将 DEX 字节码直接编译成适合你手机 CPU 架构的 本地机器码 (Native Code)，并存为 `.oat` 或 `.art` 文件。好处： 当你启动 App 时，系统可以直接执行这些预编译好的机器码，而不需要在运行时再去解释或编译，因此启动速度更快，运行效率更高。这也是为什么安装大型应用或游戏时，进度条在最后阶段会停留较长时间的原因——系统正在后台进行繁重的编译优化工作。


## 注册与完成

文件和代码都就位了，最后一步是告诉整个系统：“嘿，我们有新成员了！”
1. 更新 PMS 记录:
  - PMS 会在自己的内部数据库中（通常是一个 XML 文件）注册这个新 App 的所有信息，包括它的包名、版本、APK 路径、数据目录、UID、以及它声明的所有组件和权限。PMS 就像是系统所有 App 的“户籍管理员”。
2. 更新 Launcher (桌面):
  - 系统会发送一个广播通知，告诉 Launcher (你的手机桌面) 有新应用安装了。
  - Launcher 收到通知后，会从 PMS 查询这个新 App 的信息，特别是它的应用名称和图标（这些信息都在 `AndroidManifest.xml` 里定义），然后在你的应用列表或主屏幕上创建快捷方式。这就是你看到图标出现的那一刻！
3. 注册 Intent Filter:
  - 系统会扫描 App 的 `AndroidManifest.xml` 中的 Intent Filter (意图过滤器)。
  - 这相当于 App 在向系统“报备”自己能干什么。例如，一个浏览器 App 会注册自己能处理 `http://` 链接，一个 PDF 阅读器会注册自己能打开 `.pdf` 文件。
  - 这样，当你点击一个网页链接或 PDF 文件时，系统就知道可以弹出哪些 App 让你选择。
4. 安装完成:
  - 系统会发送一个 `ACTION_PACKAGE_ADDED` 广播，通知其他可能关心此事件的应用（例如一些清理工具或应用管理工具）。
  - 此时，安装界面上的“安装”按钮会变成“打开”，整个流程宣告结束。