# 设备系统启动

## 硬件概念

一般我们通常会接触到很多硬件相关的概念，例如 ARM、Cortext、STM、X86 等，这些概念其实存在严格的分层，但是我们有时候就混用了，这里按照三个层次来对这些概念做一些澄清。

1. 指令集架构

是架构/指令集（ISA），定义了 CPU 能识别和执行的所有指令、寄存器、寻址方式、数据类型、异常机制等。，经典的有 ARM、x86、MIPS、RISC-V、8051等。它是CPU的“语言规范”和“规则手册”，但只是纸面标准，不涉及具体电路和实现细节。

2. CPU 内核

针对于不同的指令集架构，会设计一个电路来支持这些指令集架构，这个电路就叫 CPU 内核。如 Cortex-M3、8086内核、8051内核等，这些是“设计”而不是“芯片”本身。 例如 Cortex-M3 本身不是芯片，而是 ARM 公司设计的一个内核 IP（知识产权核），这些内核可以被不同厂商用于制造实际的芯片（产品）。

3. Soc 或者 微处理器

不同的芯片厂商，买到 CPU 内核的授权，就可以按照该内核设计来实现自己的芯片，此时产出的是具体的可用的物理芯片，如 STM32、Intel 8086、手机用的高通/联发科芯片等。


假如我是一个手机公司，我可以直接从高通去买现成的芯片集成到我的手机主板上，我也可以自己设计自己的 Soc，例如华为、小米等基于 CPU 内核设计自己的 Soc，但是有个问题，就算可以设计了自己的 Soc，芯片生产工艺的复杂性导致还需要下游芯片制造商去生产，这就很容易因为 ”卡脖子“ 的问题导致流产。


## Android 上电启动(by ai)

### 1. 上电（Power On）

- 用户按下电源键，设备通电。
- 电源管理芯片（PMIC）启动，给主板和主芯片（SoC）供电。
- SoC复位，准备开始执行代码。

### 2. Boot ROM 阶段

- Boot ROM是固化在SoC内部的只读存储器，内容不可更改。
- 上电后，SoC自动执行Boot ROM代码。
- 主要任务：
  - 初始化最基础的硬件（如时钟、引脚、存储控制器）。
  - 按芯片设计，从指定存储介质（如eMMC、UFS、SD卡、NAND等）的特定位置读取Bootloader（通常是第一阶段Bootloader，如SPL、SBL、BL1等）。
  - 校验Bootloader的完整性和签名（安全启动）。
  - 把Bootloader加载到RAM，跳转执行。

### 3. Bootloader 阶段

- Bootloader通常分为多级（如第一阶段SPL/BL1，第二阶段U-Boot/BL2等）。
- 主要任务：
  - 进一步初始化硬件（如内存、串口、显示、分区表等）。
  - 检查和解析分区表，查找boot分区（里面存放内核、ramdisk、设备树）。
  - 校验内核镜像签名（安全启动）。
  - 把**内核（kernel）、ramdisk、设备树（dtb）**等加载到RAM的指定地址。
  - 设置内核启动参数（如命令行、根文件系统位置）。
  - 跳转到内核入口地址，开始执行内核。

### 4. 内核（Kernel）启动阶段

- 内核（通常是Linux内核）获得控制权。
- 主要任务：
  - 初始化CPU、内存管理、驱动程序、挂载根文件系统。
  - 启动第一个用户空间进程（init进程）。
  - 继续加载Android框架和服务（如Zygote、System Server等）。


## Android 系统分区

### 分区详情

#### `boot`

启动分区，存放 linux 内核的分区，启动后 bootloader 会首先加载这个分区。

#### `system`

系统分区，包含整个 AOSP 部分，包括系统应用、系统库、框架文件等。

#### `vendor`

一般存放着实现 HAL 层逻辑的库，它包含了所有非通用、由硬件制造商（如高通、联发科、三星）或设备制造商（如小米、OPPO）提供的、用于驱动其特定硬件的专有软件。

#### `data`

用户数据分区。这是你的个人空间。它存储了：你安装的应用、应用数据、系统设置、照片、音乐、下载的文件等。这个分区是 可读写 的，并且通常是 加密 的，以保护你的隐私。恢复出厂设置主要就是清空这个分区。

#### `recovery`

恢复分区。包含一个迷你的、独立的操作系统，用于执行系统维护任务，比如：安装系统更新（OTA）、恢复出厂设置、清除缓存。当你按住特定组合键开机时，就会进入这个恢复模式（Recovery Mode）。

#### `misc`

杂项分区。一个非常小的分区，用于存储一些零散的系统设置和开关信息，比如设备的启动模式（正常启动、恢复模式等）、运营商定制信息等。


### 分区加载和启动流程

#### 通电 & 引导加载程序 (Bootloader)
1. 你按下电源键，处理器开始执行固化在芯片里的引导代码。
2. 这段代码会加载 Bootloader。Bootloader 是一个低级软件，它会进行初步的硬件初始化。
3. Bootloader 会检查 `misc` 分区或按键组合，决定是正常启动、进入恢复模式还是 Fastboot 模式。
4. 在正常启动模式下，Bootloader 的核心任务是找到 `boot` 分区，并将其中的 内核（Kernel） 和 初始虚拟磁盘（Ramdisk） 加载到内存（RAM）中。

#### 内核启动 & 初始 Ramdisk

1. 内核被加载到内存后开始运行，它是 Android 的核心，负责管理 CPU、内存、驱动等所有硬件资源。
2. 同时，Ramdisk 也被加载，它包含了一个关键的程序：`init` 进程。`init` 是 Android 系统中所有进程的“祖先”（PID=1）。

#### `init` 进程与分区挂载 (Mounting)
1. `init` 进程启动后，它的首要任务之一就是 挂载（mount） 磁盘上的各个分区，让操作系统可以访问它们。
2. 它会读取一个名为 `fstab` (File System Table) 的配置文件，这个文件定义了哪个物理分区（如 `/dev/block/by-name/system`）应该被挂载到哪个目录（如 `/system`），以及使用什么文件系统格式和挂载选项（如 `ro` 表示只读）。
3. 挂载顺序和方式：
    - `mount /system` (只读)
    - `mount /vendor` (只读)
    - `mount /data` (可读写，此时可能会提示输入密码来解密该分区)
    - `mount /cache` (可读写)
4. 至此，操作系统的文件系统骨架已经搭建完毕。

#### Zygote 和 System Server 启动
1. 分区挂载完毕后，`init` 进程会启动 Zygote 进程。
2. Zygote 是一个“应用孵化器”。它会预加载 Android 框架的核心类和资源（这些都来自刚刚挂载的 `/system` 分区），然后通过“fork”（克隆）自身的方式快速启动新的应用进程。
3. Zygote 启动的第一个关键进程是 System Server。它负责运行所有核心系统服务，如窗口管理器、活动管理器、电源管理器等。这些服务同样依赖于 `/system` 和 `/vendor` 分区中的文件。

#### 系统就绪，进入桌面
1. System Server 启动完毕后，会启动桌面应用（Launcher）。
2. 此时，你就可以与手机交互了。你安装的应用和个人数据都从 `/data` 分区读取，系统运行所需的核心文件从 `/system` 和 `/vendor` 分区读取。